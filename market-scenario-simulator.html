<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Market Scenario Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PptxGenJS Library for PPT Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.min.js"></script>

    <!-- KaTeX Libraries for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-g/BYj3kS+sNe1KzrfK+p/BglGfrM/E+MYZfLYTiB+bS8rWnKkL/P/MYP3V+u/A1c" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-hIoPIa0K8mA/C2hGf+Ktyv0S0h9TjE/3vQJ/jLzQeI/QyL7PqR/TjW/JFLBBwzP" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-CstBRsP+xI+hGA+xxG/bSGFNBReK+cuRL/Dk8BvOaMfHCRFvEmvR/hJJc8yJFVLJ" crossorigin="anonymous"></script>
    <!-- End KaTeX -->

    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4f46e5', // Indigo 600 (Button Color)
                        'secondary-blue': '#6366f1', // Indigo 500 (Accent Color)
                        'light-bg': '#f3f4f6', // Light Gray Background
                        'text-dark': '#1f2937', // Gray 800
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* Ensure the body uses the requested light gray background */
        body {
            background-color: #f3f4f6;
            color: #1f2937; /* Dark text for contrast */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Custom styling for the analysis text block */
        .prose h5 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            color: #4f46e5; /* primary-blue color */
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }
        /* Adjusted paragraph margin for cleaner breaks */
        .prose p {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Custom styling for the table element */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background-color: #ffffff; /* White background for the table */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .prose th, .prose td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Gray 200 */
        }
        .prose th {
            background-color: #f9fafb; /* Gray 50 for headers */
            font-weight: 700;
            color: #4f46e5; /* primary-blue */
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .prose table strong {
            font-weight: 800;
            color: #1f2937;
        }
        /* KaTeX Font Fix - ensures fonts load correctly */
        .katex { font-size: 1.1em; }

        /* New style for the key sub-points */
        .key-point {
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .key-point::before {
            content: 'â€¢'; /* Use a strong dot/bullet */
            position: absolute;
            left: 0.5rem;
            font-size: 1.25rem;
            line-height: 1;
            color: #4f46e5; /* Primary blue color for the dot */
            font-weight: bold;
        }
        .key-point strong {
            font-weight: 800;
            color: #1f2937;
        }

        /* PRINT STYLES for PDF Export */
        @media print {
            body {
                background-color: #fff;
            }
            /* Hide everything on the page by default */
            body > * {
                visibility: hidden !important;
            }
            
            /* Make ONLY the results container and its children visible */
            #results-container, 
            #results-container * {
                visibility: visible !important;
            }
            
            /* Reset the results container to fill the page */
            #results-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 1cm !important; /* Use margin from @page */
                border: none !important;
                box-shadow: none !important;
                color: #000 !important;
            }

            /* Ensure the report title (h4) uses black text for printing */
            #results-container h4, .prose h5, .prose p {
                color: #000 !important; /* Use black text */
            }
            .prose table {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            .prose th, .prose td {
                border: 1px solid #ddd;
            }
            .prose th {
                 background-color: #eee !important;
            }

            /* Hide the buttons from the print view */
            #button-wrapper {
                display: none !important;
            }
            
            /* Dynamic Print Footer (Date + Page) */
            #print-date-footer {
                display: block !important;
                visibility: visible !important;
                position: fixed;
                bottom: 0;
                left: 1cm;
                font-size: 9pt;
                color: #555;
            }
            #print-page-number {
                display: block !important;
                visibility: visible !important;
                position: fixed;
                bottom: 0;
                right: 1cm;
                font-size: 9pt;
                color: #555;
            }
            
            /* Custom print rules for pagination */
            @page {
                size: A4 portrait;
                margin: 1cm; /* Reduced margin */

                /* These are often unreliable, we'll use a fixed-element fallback */
                @bottom-right {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 9pt;
                }
                @bottom-left {
                    content: attr(data-date); /* Attempt to get date */
                    font-size: 9pt;
                }
            }
        } /* End @media print */
    </style>
</head>
<body class="flex justify-center pt-12 pb-24">

    <!-- Market Scenario Analyzer Section: Width increased to max-w-6xl -->
    <section id="llm-tool" class="w-full max-w-6xl px-4 sm:px-6 lg:px-8">
        <h2 class="text-5xl font-extrabold text-center mb-4 text-text-dark">
            âœ¨ Live Market Scenario Simulator
        </h2>
        <p class="text-xl text-center text-gray-600 mb-10 max-w-3xl mx-auto">
            Pose any market scenario or "What If" question and our AI will synthesize data and deliver a comprehensive, grounded impact analysis.
        </p>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-200">
            <form id="scenario-form" class="space-y-4">
                <textarea id="scenario-prompt" placeholder="Example: What is the price impact of a severe drought in the US Midwest next summer on corn and soybean futures?" rows="4" class="w-full p-4 border border-gray-300 rounded-lg bg-white text-text-dark focus:ring-secondary-blue focus:border-secondary-blue resize-none"></textarea>
                
                <!-- ANALYZE SCENARIO Button -->
                <div class="flex justify-center">
                    <button type="submit" id="submit-btn" class="w-full md:w-1/2 bg-primary-blue hover:bg-secondary-blue text-white font-bold text-lg py-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center">
                        <span id="btn-text">ANALYZE SCENARIO âœ¨</span>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </form>

            <!-- Results Display -->
            <div id="results-container" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h4 class="text-2xl font-bold mb-4 text-primary-blue">Scenario Analysis Report:</h4>
                <div id="analysis-text" class="prose max-w-none text-gray-700">
                    <!-- Analysis content will be injected here -->
                </div>
                <div id="sources-display" class="mt-6 text-sm text-gray-500 border-t border-gray-200 pt-4">
                    <!-- Sources will be injected here -->
                </div>
                
                <!-- Report Date (Injected as content for PDF) -->
                <p id="report-date" class="text-xs text-right text-gray-500 mt-4"></p>

                <!-- Wrapper for buttons -->
                <div id="button-wrapper" class="flex flex-col md:flex-row justify-center gap-4 mt-6">
                    <!-- PDF Button -->
                    <button type="button" id="pdf-btn" onclick="exportToPDF()" class="w-full md:w-1/3 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center shadow-md">
                        <span id="pdf-btn-text">ðŸ“„ Export to PDF</span>
                    </button>
                    <!-- PPT Button -->
                    <button type="button" id="ppt-btn" onclick="exportToPPT()" class="w-full md:w-1/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center shadow-md opacity-50 cursor-not-allowed" disabled>
                        <span id="ppt-btn-text">ðŸ“Š Export to PPT (Gen...)</span>
                    </button>
                    <!-- Copy Button -->
                    <button type="button" id="copy-btn" onclick="copyReport()" class="w-full md:w-1/3 bg-gray-200 hover:bg-gray-300 text-text-dark font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center shadow-md">
                        <span id="copy-btn-text">ðŸ“‹ Copy Report to Clipboard</span>
                    </button>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="mt-4 text-red-600 font-semibold hidden">
                An error occurred. Please try a different query or check the console for details.
            </div>
        </div>

        <!-- Elements used ONLY for printing -->
        <div id="print-date-footer" class="hidden"></div>
        <div id="print-page-number" class="hidden">Page <span class="page-number"></span> of <span class="total-pages"></span></div>
        <div id="print-header-title" class="hidden">Scenario Analysis Report</div>

    </section>

    <script>
        // --- Global Variables ---
        const apiUrl = "https://gemini-proxy-80hv.onrender.com/gemini"; // User's proxy
        const apiKey = ""; // API key is handled by the proxy

        // DOM Elements
        const resultsContainer = document.getElementById('results-container');
        const analysisText = document.getElementById('analysis-text');
        const sourcesDisplay = document.getElementById('sources-display');
        const reportDate = document.getElementById('report-date');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const copyBtnText = document.getElementById('copy-btn-text');
        const pdfBtn = document.getElementById('pdf-btn');
        const pptBtn = document.getElementById('ppt-btn');
        const pptBtnText = document.getElementById('ppt-btn-text');

        // State for exports
        let currentReportSummary = "";
        let currentReportTitle = "";
        
        // --- Event Listeners ---
        document.getElementById('scenario-form').addEventListener('submit', handleScenarioSubmission);
        
        /**
         * Formats and sets the date string for PDF footer.
         * This is notoriously unreliable with CSS attr(), so we set the full string.
         */
        function setPrintDate() {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const fullDateString = `Generated: ${dateString}`;
            
            // Set for HTML display
            reportDate.textContent = fullDateString;
            
            // Set for print footer (this is the one that often fails, but we try)
            const printFooter = document.getElementById('print-date-footer');
            if (printFooter) {
                printFooter.textContent = fullDateString;
            }
            // Also set attribute for CSS content()
            document.body.setAttribute('data-date', fullDateString);
        }

        /**
         * Triggers the browser's print dialog to export the report to PDF.
         */
        function exportToPDF() {
            setPrintDate(); // Ensure date is set right before printing
            window.print();
        }

        /**
         * Generates and downloads a PowerPoint file with a summary.
         */
        function exportToPPT() {
            if (!currentReportSummary) {
                alert("The report summary is still generating. Please wait a moment and try again.");
                return;
            }

            let pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16X9'; // Standard widescreen

            // Slide 1: Title Slide
            let slide1 = pptx.addSlide();
            slide1.background = { color: "F3F4F6" }; // Light gray background
            
            slide1.addText("Scenario Analysis Report", { 
                x: 0.5, y: 1.5, w: 9.0, 
                fontSize: 32, 
                fontFace: "Inter",
                bold: true, 
                color: "1F2937" // text-dark
            });
            
            slide1.addText(`Query: ${currentReportTitle}`, { 
                x: 0.5, y: 2.2, w: 9.0, 
                fontSize: 16, 
                fontFace: "Inter",
                color: "4F46E5" // primary-blue
            });
            
            slide1.addText(`BullBearJapan, Inc. | ${new Date().toLocaleDateString('en-US')}`, { 
                x: 0.5, y: 5.0, w: 9.0, 
                fontSize: 12, 
                fontFace: "Inter",
                color: "6B7280" // gray-500
            });

            // Slide 2: Summary Slide
            let slide2 = pptx.addSlide();
            slide2.background = { color: "FFFFFF" };
            
            slide2.addText("Executive Summary", { 
                x: 0.5, y: 0.25, w: 9.0, 
                fontSize: 24, 
                fontFace: "Inter",
                bold: true, 
                color: "1F2937" 
            });

            // Add summary text as bullet points
            slide2.addText(currentReportSummary, { 
                x: 0.5, y: 1.0, w: 9.0, h: 4.0, 
                fontSize: 16, 
                fontFace: "Inter",
                color: "374151", // gray-700
                bullet: true,
                valign: 'top'
            });

            // Save the file
            pptx.writeFile({ fileName: 'Scenario_Report_Summary.pptx' });
        }


        /**
         * Copies the user's prompt and the generated analysis report to the clipboard.
         */
        function copyReport() {
            const promptText = document.getElementById('scenario-prompt').value.trim();
            const reportContent = document.getElementById('analysis-text').innerText; // Use innerText to get formatted text
            const sourcesText = document.getElementById('sources-display').innerText;
            const reportDateText = document.getElementById('report-date').innerText;
            
            if (!reportContent) return;

            const fullReport = [
                "--- BullBearJapan, Inc. Scenario Analysis Report ---",
                `QUESTION: ${promptText}`,
                "\n--- ANALYSIS ---",
                reportContent,
                `\n${sourcesText}`,
                `${reportDateText}\n`,
                "-------------------------------------------------------"
            ].join('\n');

            try {
                const textarea = document.createElement('textarea');
                textarea.value = fullReport;
                textarea.style.position = 'fixed';
                textarea.style.opacity = 0;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                copyBtnText.textContent = 'âœ… Copied to Clipboard!';
                setTimeout(() => { copyBtnText.textContent = 'ðŸ“‹ Copy Report to Clipboard'; }, 2000);
            } catch (err) {
                console.error('Copy failed:', err);
                copyBtnText.textContent = 'âŒ Copy Failed!';
                setTimeout(() => { copyBtnText.textContent = 'ðŸ“‹ Copy Report to Clipboard'; }, 3000);
            }
        }

        /**
         * Converts markdown-like text to formatted HTML for display.
         * This now leaves math ( $$...$$ and $...$ ) untouched for KaTeX to render.
         * @param {string} text - The text to convert.
         * @returns {string} The HTML string.
         */
        function markdownToHtml(text) {
            let html = text.replace(/\r/g, '');

            // --- Key Point Conversion ---
            // Pattern: **Bold Label:** *Italic Content* const keyPointRegex = /\*\*(.*?):\*\*\s*\*(.*?)\*?\s*$/gm;
            html = html.replace(keyPointRegex, (match, label, content) => {
                const cleanedContent = content.trim().replace(/\*/g, ''); 
                return `<div class="key-point"><strong>${label.trim()}:</strong> ${cleanedContent}</div>`;
            });

            // --- Standard Markdown Conversion (excluding math) ---
            html = html
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italics

            // --- Symbol/Arrow Replacement ---
            html = html
                .replace(/\\downarrow/g, 'â†“')
                .replace(/\\uparrow/g, 'â†‘')
                .replace(/\\leftrightarrow/g, 'â†”')
                .replace(/\\rightarrow/g, 'â†’')
                .replace(/\\times/g, 'Ã—')
                .replace(/\\div/g, 'Ã·')
                .replace(/\\cdot/g, 'â€¢')
                .replace(/\\text{([^}]+)}/g, '$1') // Handle \text{}
                .replace(/\\mathrm{([^}]+)}/g, '$1'); // Handle \mathrm{}

            // --- Block Element Conversion (Paragraphs, Lists, Tables) ---
            const lines = html.split('\n');
            let inTable = false;
            let inList = false;
            let outputHtml = '';

            const closeTags = (currentLineIsList, currentLineIsTable) => {
                if (inTable && !currentLineIsTable) {
                    outputHtml += '</tbody></table></div>';
                    inTable = false;
                }
                if (inList && !currentLineIsList) {
                    outputHtml += '</ul>';
                    inList = false;
                }
            };

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                // Check if line is math, if so, pass it through unchanged for KaTeX
                if (line.startsWith('$$') || line.includes('$')) {
                    closeTags(false, false); // Close any open tags
                    outputHtml += `<p>${line}</p>`; // Wrap in <p> to preserve spacing
                    continue;
                }

                let isTableLine = line.startsWith('|');
                let isListLine = line.startsWith('* ') || line.startsWith('- ');
                const headingMatch = line.match(/^(#+)\s*(.*)/); // Matches ###, ####, ##### etc.
                let isHeading = headingMatch !== null;
                let isSeparator = line.match(/^\|[\s:-]*\|[\s:-]*\|/);
                let isKeyPoint = line.startsWith('<div class="key-point">');

                closeTags(isListLine, isTableLine);
                
                if (isKeyPoint) {
                    outputHtml += line; // Pass pre-formatted key points
                } else if (isHeading) {
                    const headingText = headingMatch[2].trim();
                    outputHtml += `<h5>${headingText}</h5>`; // Convert all to <h5>
                } else if (isTableLine) {
                    if (isSeparator) continue; 

                    if (!inTable) {
                        inTable = true;
                        outputHtml += '<div class="overflow-x-auto"><table class="min-w-full">';
                        const headerCells = line.split('|').filter((c, idx) => (idx > 0 && idx < line.split('|').length - 1));
                        outputHtml += '<thead><tr>' + headerCells.map(cell => `<th>${cell.trim()}</th>`).join('') + '</tr></thead><tbody>';
                    } else {
                        const rowCells = line.split('|').filter((c, idx) => (idx > 0 && idx < line.split('|').length - 1));
                        outputHtml += '<tr>' + rowCells.map(cell => `<td>${cell.trim()}</td>`).join('') + '</tr>';
                    }
                } else if (isListLine) {
                    if (!inList) {
                        inList = true;
                        outputHtml += '<ul class="list-disc ml-6 space-y-1 my-4">';
                    }
                    const content = line.substring(line.indexOf(' ') + 1).trim();
                    outputHtml += `<li>${content}</li>`;
                } else if (line) {
                    outputHtml += `<p>${line}</p>`;
                }
            }

            closeTags(false, false); // Close any remaining tags

            return outputHtml;
        }

        /**
         * Fetches data from the API with retry logic.
         */
        async function fetchWithRetry(payload, retries = 3) {
            // Check for API key *before* fetching
            if (apiKey === "PASTE_YOUR_KEY_HERE_FOR_DEPLOYMENT" || apiKey === "") {
                // We're in the secure dev environment (like Canvas)
                // The proxy will handle auth, so we don't need to check the key.
                // If deployed, this check *would* be important.
            }

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Rate limit
                        if (i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                    }

                    if (!response.ok) {
                        const errData = await response.json();
                        console.error("API Error Response:", errData);
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }
                    
                    return response.json();

                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === retries - 1) {
                        throw new Error(`Could not connect to the API after ${retries} retries. Check console for details.`);
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Asynchronously fetches the summary for the report.
         */
        async function fetchReportSummary(originalQuery, reportText) {
            try {
                const summaryPrompt = `Based on the user's original query: "${originalQuery}", provide a concise summary of the following analysis.
                The summary must be 3-5 bullet points, suitable for a single PowerPoint slide.
                Focus only on the main impacts and key takeaways.
                
                ANALYSIS TO SUMMARIZE:
                ---
                ${reportText}
                ---
                
                SUMMARY:`;

                const payload = { prompt: summaryPrompt };
                const result = await fetchWithRetry(payload);
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    currentReportSummary = candidate.content.parts[0].text;
                    // Enable the PPT button
                    pptBtn.disabled = false;
                    pptBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    pptBtnText.textContent = 'ðŸ“Š Export to PPT';
                }
            } catch (error) {
                console.error("Failed to generate summary:", error);
                // If summary fails, keep button disabled but show a different state
                pptBtnText.textContent = 'âŒ Summary Failed';
                pptBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                pptBtn.classList.add('bg-red-500', 'cursor-not-allowed');
            }
        }

        /**
         * Main handler for submitting the scenario form.
         */
        async function handleScenarioSubmission(e) {
            e.preventDefault();
            
            const userQuery = document.getElementById('scenario-prompt').value.trim();
            if (!userQuery) return;

            // 1. Reset UI and show loading state
            resultsContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            analysisText.innerHTML = '';
            sourcesDisplay.innerHTML = '';
            reportDate.textContent = '';
            
            btnText.textContent = 'ANALYZING...';
            loadingSpinner.classList.remove('hidden');
            submitBtn.disabled = true;
            
            // Reset and disable PPT button for the new query
            currentReportSummary = "";
            currentReportTitle = userQuery; // Store title for PPT
            pptBtn.disabled = true;
            pptBtn.classList.add('opacity-50', 'cursor-not-allowed');
            pptBtn.classList.remove('bg-red-500');
            pptBtnText.textContent = 'ðŸ“Š Export to PPT (Gen...)';


            try {
                // Define the LLM's role for the main report
                const systemPrompt = `You are a Senior Commodity Analyst for BullBearJapan, Inc.. Your role is to provide a concise, data-grounded analysis of market scenarios.

                Structure your response clearly using Markdown headings (starting with #####) for the following sections:
                1. Impact Summary (Supply, Demand, and Net Effect - use a Markdown table)
                2. Affected Key Price Drivers (Reference concepts like Freight, Exchange Rates, COT, etc.)
                3. Risk Mitigation Strategy (Provide a high-level suggestion)
                
                When describing key points within a section, format them as: **Bold Label:** *Italic descriptive text*. This is essential for the front-end parser.
                
                Use LaTeX for all formulas, wrapped in $...$ for inline math and $$...$$ for display math. For example, use $\\times$ for multiplication.

                The analysis must be grounded in the current information you search for. Maintain a professional, objective, and analytical tone.`;

                // Note: The user's proxy seems to only want the prompt, not the full payload.
                // We'll send the prompt as defined in their provided file.
                // The system prompt and tools (grounding) must be handled *by their proxy*.
                const payload = { 
                    prompt: userQuery,
                    // Assuming the user's proxy is hard-coded to add the system prompt and grounding.
                    // If not, this structure would be needed:
                    // contents: [{ parts: [{ text: userQuery }] }],
                    // tools: [{ "google_search": {} }],
                    // systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const result = await fetchWithRetry(payload);

                // 2. Process Response
                const candidate = result.candidates?.[0];
                let generatedText = "Analysis not available.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;

                    // Extract grounding sources (if the proxy passes them back)
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                } else {
                     throw new Error("Invalid response structure received from API.");
                }


                // 3. Update Results UI with Main Report
                const formattedHtml = markdownToHtml(generatedText);
                analysisText.innerHTML = formattedHtml;

                // 4. Render Math Formulas with KaTeX
                // This finds all math delimiters and renders them
                renderMathInElement(analysisText, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ],
                    throwOnError: false // Prevents one bad formula from breaking the whole page
                });
                
                // 5. Display Sources
                if (sources.length > 0) {
                    sourcesDisplay.innerHTML = '<p class="font-bold mb-2">Sources:</p>';
                    sources.forEach((source, index) => {
                        sourcesDisplay.innerHTML += `<p class="truncate"><a href="${source.uri}" target="_blank" class="text-secondary-blue hover:text-primary-blue transition duration-150">${index + 1}. ${source.title}</a></p>`;
                    });
                } else {
                    sourcesDisplay.innerHTML = '<p class="text-gray-500">No external sources were used for this conceptual scenario.</p>';
                }
                
                // 6. Set Date and show container
                setPrintDate(); // Set date for both display and PDF
                resultsContainer.classList.remove('hidden');
                
                // 7. Scroll to results
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // 8. Start the (non-blocking) summary generation
                fetchReportSummary(userQuery, generatedText);

            } catch (error) {
                console.error("Scenario Analysis Error:", error);
                let detail = "An unknown error occurred.";
                if (error.message.includes("API key")) {
                    detail = "API Key error. If deploying, ensure your key is set in the script.";
                } else if (error.message.includes("connect")) {
                    detail = "Network/Throttling Error: Could not connect to the API after retries. Check your console for details or try again shortly.";
                }
                errorMessage.textContent = detail;
                errorMessage.classList.remove('hidden');
            } finally {
                // 9. Hide loading state
                btnText.textContent = 'ANALYZE SCENARIO âœ¨';
                loadingSpinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

