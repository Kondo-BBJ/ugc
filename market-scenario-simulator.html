<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Market Scenario Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors (Blue theme) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4f46e5', // Indigo 600 (Button Color)
                        'secondary-blue': '#6366f1', // Indigo 500 (Accent Color)
                        'light-bg': '#f3f4f6', // Light Gray Background
                        'text-dark': '#1f2937', // Gray 800
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }

        async function sendPrompt(prompt) {
  const response = await fetch(apiUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ prompt })
  });

  const data = await response.json();
  console.log(data); // You can replace this with code to display the result in your UI
}

    </script>
    <style>
        /* Ensure the body uses the requested light gray background */
        body {
            background-color: #f3f4f6;
            color: #1f2937; /* Dark text for contrast */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Custom styling for the analysis text block */
        .prose h5 {
            font-size: 1rem; /* text-base */
            font-weight: 700; /* font-bold */
            color: #4f46e5; /* primary-blue color */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        /* Adjusted paragraph margin for cleaner breaks */
        .prose p {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Custom styling for the table element */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background-color: #ffffff; /* White background for the table */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .prose th, .prose td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Gray 200 */
        }
        .prose th {
            background-color: #f9fafb; /* Gray 50 for headers */
            font-weight: 700;
            color: #4f46e5; /* primary-blue */
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        /* Ensure the strong tag inside the table works */
        .prose table strong {
            font-weight: 800;
            color: #1f2937;
        }
        /* Styling for the LaTeX formula block (Display Math) */
        .formula-block {
            background-color: #f3f4f6; /* Light gray background */
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            text-align: center;
            font-family: monospace; /* Monospace font for code/formula */
            white-space: pre-wrap;
            overflow-x: auto;
            color: #4f46e5; /* Primary blue for prominence */
            font-weight: 600;
        }
        /* New style for inline math */
        .inline-formula {
            padding: 0 0.25rem;
            background-color: #eef2ff; /* Indigo 50 */
            border-radius: 0.25rem;
            font-weight: 500;
        }
        /* New style for the key sub-points */
        .key-point {
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .key-point::before {
            content: 'â€¢'; /* Use a strong dot/bullet */
            position: absolute;
            left: 0.5rem;
            font-size: 1.25rem;
            line-height: 1;
            color: #4f46e5; /* Primary blue color for the dot */
            font-weight: bold;
        }
        .key-point strong {
            font-weight: 800;
            color: #1f2937;
        }

        /* PRINT STYLES for PDF Export */
        @media print {
            /* Hide everything on the page by default */
            body > * {
                visibility: hidden !important;
            }
            
            /* Make ONLY the results container and its children visible */
            #results-container, 
            #results-container * {
                visibility: visible !important;
            }
            
            /* Reset the results container to fill the page */
            #results-container {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }

            /* Ensure the report title (h4) uses black text for printing */
            #results-container h4 {
                color: #1f2937 !important; /* Use black text */
            }

            /* Hide the buttons from the print view */
            #button-wrapper {
                display: none !important;
            }
            
            /* Custom print footer (Only Page Number is reliable) */
            @page {
                size: A4 portrait;
                margin: 1.5cm; /* Ensure space for header/footer */

                /* Page Number */
                @bottom-right {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 8pt;
                    color: #555;
                }
            }
        }
    </style>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/dist/pptxgen.bundle.js"></script>

</head>
<body class="flex justify-center pt-12 pb-24">

    <!-- Market Scenario Analyzer Section: Width increased to max-w-6xl -->
    <section id="llm-tool" class="w-full max-w-6xl px-4 sm:px-6 lg:px-8">
        <h2 class="text-4xl font-extrabold text-center mb-4 text-text-dark">
            âœ¨ Live Market Scenario Simulator
        </h2>
        <p class="text-lg text-center text-gray-600 mb-10 max-w-3xl mx-auto">
            Pose any market scenario or "What If" question and our AI will synthesize data and deliver a comprehensive, grounded impact analysis.
        </p>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-200">
            <form id="scenario-form" class="space-y-4">
                <textarea id="scenario-prompt" placeholder="Example: What is the price impact of a severe drought in the US Midwest next summer on corn and soybean futures?" rows="4" class="w-full p-4 border border-gray-300 rounded-lg bg-white text-text-dark focus:ring-secondary-blue focus:border-secondary-blue resize-none"></textarea>
                
                <!-- ANALYZE SCENARIO Button: Now w-1/2 and centered on medium screens and up -->
                <div class="flex justify-center">
                    <button type="submit" id="submit-btn" class="w-full md:w-1/2 bg-primary-blue hover:bg-secondary-blue text-white font-bold text-lg py-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center">
                        <span id="btn-text">ANALYZE SCENARIO âœ¨</span>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </form>

            <!-- Results Display -->
            <div id="results-container" class="mt-8 pt-6 border-t border-gray-200 hidden">
                <h4 class="text-2xl font-bold mb-4 text-primary-blue">Scenario Analysis Report:</h4>
                <div id="analysis-text" class="prose max-w-none text-gray-700">
                    <!-- Analysis content will be injected here -->
                </div>
                <div id="sources-display" class="mt-6 text-sm text-gray-500 border-t border-gray-200 pt-4">
                    <!-- Sources will be injected here -->
                </div>
                
                <!-- NEW: Report Date (Injected as content) -->
                <p id="report-date" class="text-xs text-right text-gray-500 mt-4"></p>

                <!-- Wrapper for buttons -->
                <div id="button-wrapper" class="flex flex-col md:flex-row justify-center gap-4 mt-6">
                    <!-- PDF Button -->
                    <button type="button" id="pdf-btn" onclick="exportToPDF()" class="w-full md:w-1/4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center shadow-md">
                        <span id="pdf-btn-text">ðŸ“„ Export to PDF</span>
                    </button>

		    <!-- PPT Button -->
		    <button type="button" id="ppt-btn" onclick="exportToPPT()" class="w-full md:w-1/4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center shadow-md">
			<span id="ppt-btn-text">ðŸ“Š Export to PPT</span>
		    </button>


                    <!-- Copy Button -->
                    <button type="button" id="copy-btn" onclick="copyReport()" class="w-full md:w-1/4 bg-gray-200 hover:bg-gray-300 text-text-dark font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center shadow-md">
                        <span id="copy-btn-text">ðŸ“‹ Copy Report to Clipboard</span>
                    </button>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="mt-4 text-red-600 font-semibold hidden">
                An error occurred. Please try a different query or check the console for details.
            </div>
        </div>
    </section>

    <script>
        document.getElementById('scenario-form').addEventListener('submit', handleScenarioSubmission);

        // NOTE: The apiKey is intentionally left blank for the environment to provide it at runtime.
        const apiUrl = "https://gemini-proxy-80hv.onrender.com/gemini"; // Replace with your actual Render URL

        const resultsContainer = document.getElementById('results-container');
        const analysisText = document.getElementById('analysis-text');
        const sourcesDisplay = document.getElementById('sources-display');
        const reportDate = document.getElementById('report-date'); // NEW Element reference
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        
        /**
         * Triggers the browser's print dialog to export the report to PDF.
         */
        function exportToPDF() {
            // No date injection needed here; the date is already in the DOM content.
            window.print();
        }

        /**
         * Copies the user's prompt and the generated analysis report to the clipboard.
         */
      function copyReport() {
  const promptText = document.getElementById('scenario-prompt').value.trim();
  const reportContentHTML = document.getElementById('analysis-text').innerHTML;
  const sourcesHTML = document.getElementById('sources-display').innerHTML;
  const reportDateText = document.getElementById('report-date').innerText;
  const copyButtonText = document.getElementById('copy-btn-text');

  if (!reportContentHTML) return;

  // Inject inline styles ONLY into <h5> tags
  const styledContent = reportContentHTML.replace(
    /<h5>(.*?)<\/h5>/g,
    '<h5 style="color:#4f46e5; font-weight:700; font-size:16px; margin-top:16px; margin-bottom:8px;">$1</h5>'
  );

  const fullHTML = `
    <div style="font-family:Segoe UI, sans-serif; color:#1f2937; line-height:1.6;">
      <h3 style="color:#4f46e5; font-weight:700;">BullBearJapan, Inc. Scenario Analysis Report</h3>
      <p><strong>QUESTION:</strong> ${promptText}</p>
      <hr style="margin:16px 0;">
      ${styledContent}
      <hr style="margin:16px 0;">
      ${sourcesHTML}
      <p style="text-align:right; font-size:12px; color:#6b7280;">${reportDateText}</p>
    </div>
  `;

  navigator.clipboard.write([
    new ClipboardItem({
      "text/html": new Blob([fullHTML], { type: "text/html" })
    })
  ]).then(() => {
    copyButtonText.textContent = 'âœ… HTML Copied!';
    setTimeout(() => {
      copyButtonText.textContent = 'ðŸ“‹ Copy Report to Clipboard';
    }, 2000);
  }).catch(err => {
    console.error('HTML copy failed:', err);
    copyButtonText.textContent = 'âŒ Copy Failed!';
    setTimeout(() => {
      copyButtonText.textContent = 'ðŸ“‹ Copy Report to Clipboard';
    }, 3000);
  });
}


        /**
         * Converts basic Markdown (headings, bold, tables, lists, and symbols) to HTML.
         * @param {string} markdownText - The text to convert.
         * @returns {string} The HTML string.
         */
        function markdownToHtml(markdownText) {
            // 1. Remove Windows carriage returns
            let html = markdownText.replace(/\r/g, '');
            
            // --- FIX: Convert Key Point pattern to structured HTML ---
            // Pattern: **Bold Label:** *Italic Content* (This often breaks and leaves an asterisk)
            // Replacement: <div class="key-point"><strong>Bold Label:</strong> Non-Italic Content</div>
            const keyPointRegex = /\*\*(.*?):\*\*\s*\*(.*?)\*?\s*$/gm;
            html = html.replace(keyPointRegex, (match, label, content) => {
                const cleanedContent = content.trim().replace(/\*/g, ''); 
                return `<div class="key-point"><strong>${label.trim()}:</strong> ${cleanedContent}</div>`;
            });
            // --------------------------------------------------------------------------

// 2. Convert scoped **bold** and *italics*
html = html.replace(/(^|\s)\*\*(.+?)\*\*(?=\s|[.,;!?]|$)/g, '$1<strong>$2</strong>');
html = html.replace(/(^|\s)\*(.+?)\*(?=\s|[.,;!?]|$)/g, '$1<em>$2</em>');
            
            // --- Handle inline LaTeX math $...$ ---
            html = html.replace(/(?<!\$)\$(?!\$)([^\s\$][^\$]*[^\s\$])(?<!\$)\$(?!\$)/g, (match, content) => {
                let inlineFormula = content.trim();
                
                inlineFormula = inlineFormula.replace(/\\text\s*{([^}]+)\s*}/g, '$1');
                inlineFormula = inlineFormula.replace(/\\mathrm\s*{([^}]+)\s*}/g, '$1');
                
                inlineFormula = inlineFormula.replace(/\\times/g, 'Ã—');
                inlineFormula = inlineFormula.replace(/\\div/g, 'Ã·');
                inlineFormula = inlineFormula.replace(/\\cdot/g, 'â€¢');
                
                inlineFormula = inlineFormula.replace(/\\/g, '');

                return `<span class="inline-formula font-mono text-primary-blue">${inlineFormula.trim()}</span>`;
            });
            // ------------------------------------------

            // --- FIX: Handle LaTeX Display Math $$...$$ by wrapping it in a styled block ---
            html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, content) => {
                let formula = content.trim();

                formula = formula.replace(/\\text\s*{([^}]+)\s*}/g, '$1');
                formula = formula.replace(/\\mathrm\s*{([^}]+)\s*}/g, '$1');

                formula = formula.replace(/\\times/g, 'Ã—');
                formula = formula.replace(/\\div/g, 'Ã·');
                formula = formula.replace(/\\cdot/g, 'â€¢');
                
                formula = formula.replace(/\\/g, '');
                
                return `<div class="formula-block">${formula.trim()}</div>`;
            });
            // --------------------------------------------------------------------------

            // 3. Replace common directional/impact symbols with Unicode Emojis
            html = html.replace(/\\downarrow/g, 'â†“');      // LaTeX Down Arrow
            html = html.replace(/\\uparrow/g, 'â†‘');        // LaTeX Up Arrow
            html = html.replace(/\\leftrightarrow/g, 'â†”');  // LaTeX Left-Right Arrow
            html = html.replace(/\\up/g, 'â†‘'); 
            html = html.replace(/\\down/g, 'â†“'); 
            html = html.replace(/\\neutral/g, 'â†”'); 

            // 4. Final cleanup for lone asterisks: Remove any remaining single asterisks. 
            html = html.replace(/\*/g, ''); 

            const lines = html.split('\n');
            let inTable = false;
            let inList = false;
            let outputHtml = '';

            // Utility to close open tags
            const closeTags = (currentLineIsList, currentLineIsTable) => {
                if (inTable && !currentLineIsTable) {
                    outputHtml += '</tbody></table></div>';
                    inTable = false;
                }
                if (inList && !currentLineIsList) {
                    outputHtml += '</ul>';
                    inList = false;
                }
            };

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                let isTableLine = line.startsWith('|');
                let isListLine = line.startsWith('* ') || line.startsWith('- ');
                
                const headingMatch = line.match(/^(#+)\s*(.*)/);
                let isHeading = headingMatch !== null;
                
                let isSeparator = line.match(/^\|[\s:-]*\|[\s:-]*\|/); // Markdown table separator
                
                // Check if the line is already a processed formula block or key point
                let isFormulaBlock = line.startsWith('<div class="formula-block">') || line.startsWith('<span class="inline-formula');
                let isKeyPoint = line.startsWith('<div class="key-point">');


                // Handle closing any open blocks first if the new line breaks the block type
                closeTags(isListLine, isTableLine);
                
                if (isFormulaBlock || isKeyPoint) {
                    // Pass already-formatted blocks through
                    outputHtml += line;
                } else if (isHeading) {
                    // Extract the text content from the heading match
                    const headingText = headingMatch[2].trim();
                    // We consistently convert all Markdown headings to <h5> tags
                    outputHtml += `<h5>${headingText}</h5>`;
                } else if (isTableLine) {
                    if (isSeparator) {
                        continue; // Skip the separator line
                    }

                    // Start of a table (header or row)
                    if (!inTable) {
                        inTable = true;
                        outputHtml += '<div class="overflow-x-auto"><table class="min-w-full">';

                        // The current line is the header row
                        const headerCells = line.split('|').filter(c => c.trim() !== '');
                        outputHtml += '<thead><tr>' + headerCells.map(cell => `<th>${cell.trim()}</th>`).join('') + '</tr></thead><tbody>';
                    } else {
                        // Table row
                        const rowCells = line.split('|').filter(c => c.trim() !== '');
                        outputHtml += '<tr>' + rowCells.map(cell => `<td>${cell.trim()}</td>`).join('') + '</tr>';
                    }
                } else if (isListLine) {
                    if (!inList) {
                        inList = true;
                        // Add Tailwind classes for disc style and margin for good spacing
                        outputHtml += '<ul class="list-disc ml-6 space-y-1 my-4">';
                    }
                    // Remove the list marker (e.g., "* " or "- ") and wrap in <li>
                    const content = line.substring(line.indexOf(' ') + 1).trim();
                    outputHtml += `<li>${content}</li>`;

                } else if (line) {
                    // This is a paragraph line
                    // Wrap in <p> tag for block spacing (p class handles the requested line break)
                    outputHtml += `<p>${line}</p>`;
                }
                // Ignore empty lines, unless they are closing a block
            }

            // Close any remaining open tags at the end of the content
            closeTags(false, false);

            return outputHtml;
        }


        /**
         * Generic function to handle the fetch request with exponential backoff.
         * @param {object} payload - The request body payload.
         * @param {number} retries - Number of retry attempts.
         */
        async function fetchWithRetry(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        // Rate limit exceeded, prepare to retry
                        if (i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s, ...
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                    }

                    if (!response.ok) {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                    return response.json();

                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === retries - 1) {
                        throw new Error("Failed to connect to the Gemini API after multiple retries.");
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function handleScenarioSubmission(e) {
            e.preventDefault();
            
            const userQuery = document.getElementById('scenario-prompt').value.trim();
            if (!userQuery) return;

            // 1. Reset UI and show loading state
            resultsContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            analysisText.innerHTML = '';
            sourcesDisplay.innerHTML = '';
            reportDate.textContent = ''; // Clear date field
            btnText.textContent = 'ANALYZING...';
            loadingSpinner.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                // Define the LLM's role and expected output format
                const systemPrompt = `You are a Senior Commodity Analyst for BullBearJapan, Inc.. Your role is to provide a concise, data-grounded analysis of market scenarios.

                Structure your response clearly using Markdown headings (starting with #####) for the following sections:
                1. Impact Summary (Supply, Demand, and Net Effect - use a Markdown table)
                2. Affected Key Price Drivers (Reference concepts like Freight, Exchange Rates, COT, etc.)
                3. Risk Mitigation Strategy (Provide a high-level suggestion)
                
                When describing key points within a section, format them as: **Bold Label:** *Italic descriptive text*. This is essential for the front-end parser.
                
                When using the Crush Margin formula, please use the standard conversion factors based on the yield per bushel (e.g., 44 lbs of meal and 11 lbs of oil) and use clear variable names in your LaTeX.

                The analysis must be grounded in the current information you search for. Maintain a professional, objective, and analytical tone.`;

                const payload = {
  prompt: userQuery
};

                const result = await fetchWithRetry(payload);

                // 2. Process Response
                const candidate = result.candidates?.[0];
                let generatedText = "Analysis not available.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;

                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                } else {
                     throw new Error("Invalid response structure received from API.");
                }


                // 3. Update Results UI
                const formattedHtml = markdownToHtml(generatedText);
                analysisText.innerHTML = formattedHtml;
                
                if (sources.length > 0) {
                    sourcesDisplay.innerHTML = '<p class="font-bold mb-2">Sources:</p>';
                    sources.forEach((source, index) => {
                        sourcesDisplay.innerHTML += `<p class="truncate"><a href="${source.uri}" target="_blank" class="text-secondary-blue hover:text-primary-blue transition duration-150">${index + 1}. ${source.title}</a></p>`;
                    });
                } else {
                    sourcesDisplay.innerHTML = '<p class="text-gray-500">No external sources were used for this conceptual scenario.</p>';
                }
                
                // Set the current date into the new report element
                const now = new Date();
                const dateString = now.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                reportDate.textContent = `Report Generated: ${dateString}`;


                resultsContainer.classList.remove('hidden');
                
                // Scroll to the results
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                console.error("Scenario Analysis Error:", error);
                errorMessage.classList.remove('hidden');
            } finally {
                // 4. Hide loading state
                btnText.textContent = 'ANALYZE SCENARIO âœ¨';
                loadingSpinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }


function exportToPPT() {
  const container = document.getElementById("analysis-text");
  const pptx = new PptxGenJS();

  // Title Slide (centered for 16:9)
  const titleSlide = pptx.addSlide();
  titleSlide.addText("BullBearJapan, Inc.", {
    x: 0.5, y: 1.5, w: 9.0,
    fontSize: 32, bold: true, align: "center", color: "003366"
  });
  titleSlide.addText("Scenario Analysis Report", {
    x: 0.5, y: 2.5, w: 9.0,
    fontSize: 24, align: "center", color: "444444"
  });
  titleSlide.addText(`Generated: ${new Date().toLocaleDateString()}`, {
    x: 0.5, y: 3.5, w: 9.0,
    fontSize: 14, align: "center", color: "888888"
  });

  const children = Array.from(container.children);
  let currentSlide = null;
  let slideIndex = 1;
  let bullets = [];

  children.forEach((el, idx) => {
    if (el.tagName === "H5") {
      // Flush previous bullets
      if (currentSlide && bullets.length > 0) {
        const bulletText = bullets.join("\n");
        currentSlide.addText(bulletText, {
          x: 0.5, y: 1.4, w: 9.0, h: 3.8,
          fontSize: 18, color: "444444", lineSpacingMultiple: 1.2
        });
        bullets = [];
      }

      // New slide
      currentSlide = pptx.addSlide();

      // Title box (slightly higher)
      currentSlide.addText(el.innerText, {
        x: 0.5, y: 0.4, w: 9.0, h: 1.0,
        fontSize: 26, bold: true, align: "center", color: "003366"
      });

      // Footer (moved up to stay inside slide)
      currentSlide.addText(`BullBearJapan, Inc. â€” Slide ${slideIndex}`, {
        x: 0.5, y: 5.4, w: 9.0,
        fontSize: 10, color: "888888", align: "center"
      });

      slideIndex++;
    } else if (
      currentSlide &&
      (el.tagName === "P" || el.tagName === "LI" || el.classList.contains("key-point"))
    ) {
      const text = el.innerText.trim();
      if (text && text !== "---") {
        bullets.push(`â€¢ ${text}`);
      }
    }

    // Final flush
    if (idx === children.length - 1 && currentSlide && bullets.length > 0) {
      const bulletText = bullets.join("\n");
      currentSlide.addText(bulletText, {
        x: 0.5, y: 1.4, w: 9.0, h: 3.8,
        fontSize: 18, color: "444444", lineSpacingMultiple: 1.2
      });
    }
  });

  pptx.writeFile("Scenario_Analysis_Report.pptx");
}

    </script>
</body>
</html>
