<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Feed Reader (RSS & Iframe)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3498db', // Bright Blue
                        'secondary': '#5dade2', // Optional lighter blue
                            },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }; 
    </script>
    <style>
        /* Custom styles for a clean, modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f7;
        }
        
        /* --- ADDED: Custom, extra-wide max width (1800px) --- */
        .max-w-extra-wide {
            max-width: 1800px;
        }
        /* ----------------------------------------------------- */

        .feed-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .feed-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .article-image {
            width: 100%;
            height: 180px; 
            object-fit: cover; 
            border-radius: 0.5rem;
            margin-bottom: 0; 
        }
        
        /* --- HIGHLY VISIBLE ACTIVE STATE (Explicit Styles) --- */
        
        /* Define the base styles for non-active buttons (this is crucial for resetting) */
        .nav-link, .sub-nav-link {
            /* These styles are also explicitly added in JS to the generated HTML buttons for robustness */
            @apply bg-white text-gray-600 border border-gray-200 shadow-sm font-normal;
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* Prevent wrapping */
        }

        /* Define the ACTIVE state with maximum contrast */
        .nav-link.active, .sub-nav-link.active {
            /* Ensure maximum priority by overriding base styles */
            @apply !bg-primary !text-white !border-primary !shadow-lg !shadow-primary/50 !font-semibold; 
        }

        .nav-link:hover:not(.active), .sub-nav-link:hover:not(.active) {
            /* Clear hover effect on non-active buttons */
            @apply bg-gray-100 border-gray-300;
        }
        /* ----------------------------------------------------- */

        /* Specific style for modal content */
        .modal-body img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        /* Responsive iframe container for aspect ratio (1600/900 * 100 = 177.78% based on user's previous iframe sizes) */
        .iframe-container {
            position: relative; 
            width: 100%; 
            /* Aspect ratio: 1600/900 * 100 = 177.78%. */
            padding-top: 177.78%; 
        }
        .iframe-container iframe {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: 0;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Modal Overlay (For RSS Article Details) -->
    <div id="modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 pr-12"></h2>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition duration-150">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="modalContent" class="text-gray-700">
                    <!-- Article content injected here -->
                </div>
            </div>
        </div>
    </div>

    
    <!-- Main Content Area -->
    <div class="max-w-extra-wide mx-auto w-full">
        <main class="pt-2 px-4 md:pt-4 md:px-6">

<!-- RSS Ticker Section -->

        <iframe width="100%" height="30" src="https://rss.app/embed/v1/ticker/IwsWFxhXmdcxnfGV" frameborder="0"></iframe>
    

            <!-- 1. Combined Header and Main Category Navigation (Side-by-side on MD+) -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-2 border-b pb-1">
                <h1 class="text-2xl font-bold text-gray-800 mb-2 md:mb-0 md:min-w-fit">News & Topics</h1>
                <nav id="categoryNavContainer" class="p-2 md:ml-6 md:flex-grow">
                    <div id="categoryNav" class="flex flex-wrap md:flex-nowrap gap-2 overflow-x-auto">
                        <!-- Categories injected here -->
                    </div>
                </nav>
            </div>


            <!-- 2. Sub-Category Navigation (Removed h2 title) -->
            <nav id="subCategoryNav" class="p-1 mb-4 flex flex-wrap gap-1 overflow-x-auto">
                <!-- Sub-categories injected here -->
            </nav>
            
            <header class="mb-2">
                <h3 class="text-3xl font-extrabold text-gray-900 mb-4">
                    <span id="activeCategoryTitle" class="text-primary"></span> 
                    <span id="activeSubCategoryTitle" class="text-gray-500 font-semibold text-xl"></span>
                </h3>
            </header>
            
            <!-- 3. Search Box - Only visible/relevant for traditional RSS feeds -->
            <div id="searchContainer" class="mb-8 hidden">
                <input type="text" id="articleSearch" placeholder="Search articles by title, snippet, or content..."
                       class="w-full p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-primary focus:border-primary transition duration-150">
            </div>

            <!-- Feed Content Grid (For RSS Articles or Iframe) -->
            <section id="feedContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                <div class="2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2 text-center p-12 text-gray-500 italic">Please select a sub-feed to view content.</div>
            </section>
        </main>
    </div>

    <script type="text/javascript">
        // --- Configuration & Constants ---
        const CORS_PROXY = 'https://api.rss2json.com/v1/api.json?rss_url=';
        const LAST_CATEGORY_KEY = 'lastSelectedCategory';
        const LAST_SUB_CATEGORY_KEY = 'lastSelectedSubCategory';

        
        // RSS_FEEDS: Updated structure with new categories and content moved to placeholders.
        const RSS_FEEDS = {
            "Grains": {
                icon: "üåæ",
                subCategories: [
                    // --- UPDATED: iframeUrl added to All Grain News ---
                    { 
                        name: "All Grain News", 
                        url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/_Y2YL3oJVWQf7ho7X"
                    },
                    { name: "Market", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/_qng8r58lFlMBpOZc" },
                    { name: "Grain Companies", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/_z6kn9iGdXhhbcPv5" },
                    { name: "Earnings", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/_R6bIIzyNtPosCB5d" },
                    { name: "M&A", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/_3UjeWUu6sKpDumGc" },
                    { name: "Corporate Strategies", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/PQe5lOjtabFUpm7F" },
                    { name: "Transport", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/_gWifx53kvpHIoRDk" },
                    { name: "International", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/elvhpo03SJvQRhyQ" },
                    { name: "Aquaculture", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/DulIKsADYvBxerLO" },
                    { name: "Biotechnology", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/CrJ0jobzSJlykdts" },
                    { name: "Biofuel", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/Aq24kWymlK925Dyj" },
                    { name: "Tariffs", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/UqY9Q4rOozCFbPRT" },
                    { name: "Ukraine", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/vcbba8osqBz0g1Nl" },
                    { name: "Progressive Farmer", url: [],
                        iframeUrl: "https://rss.app/embed/v1/wall/l38pqlScfiCfS5WA" }
                ]
            },
            "Ocean Freight": {
                icon: "üö¢",
                subCategories: [
                    { 
                        name: "All Ocean Freight News", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/_lx3RTxVDk688nW3g" // All Ocean Freight News (Placeholder)
                    },
                    { 
                        name: "Top Stories", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/51WU6x9OsTYkmLhx" 
                    },
                    { 
                        name: "Market", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/INOOtf2PVcKb4FJe"
                    },
                    { 
                        name: "International", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/QqRvU5DDtXW0v4tb" 
                    },
                    { 
                        name: "Dry Bulk", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/cC0dJuTZdaSHfEjV" 
                    },
                    { 
                        name: "Cargo", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/4qZGi0ch96yiLzSp" 
                    },
                    { 
                        name: "Oil & Bunker", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/_XoqJqBuTplmnRv7G" 
                    },
                    { 
                        name: "Commodity", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/nJDRUvCzbhPKYVhI" 
                    },
                    { 
                        name: "Insurance, Law & Safety", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/_shO0EuFuRSYMWIYT" 
                    },
                    { 
                        name: "Tradewinds", 
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/T4zbnznqImXVwPxD" 
                    },
                ]
            },
            "Financial": {
                icon: "üí∞",
                subCategories: [
                    { name: "All Financial News", iframeUrl: "https://rss.app/embed/v1/wall/_JnbnULRoTDeR8PDC" }, 
                    { name: "Currencies", iframeUrl: "https://rss.app/embed/v1/wall/_3dESGAxS30W3MfWs" },
                    { name: "Bloomberg", iframeUrl: "https://rss.app/embed/v1/wall/tPAc0SvHPmIRGHf6" },
                    { name: "The Economist", iframeUrl: "https://rss.app/embed/v1/wall/tteFpb6z51Z5goPI" },
                    { name: "FT", iframeUrl: "https://rss.app/embed/v1/wall/tIe6rqLRpZd5pg4E" },
                    { name: "Reuters", iframeUrl: "https://rss.app/embed/v1/wall/tI620kUKzs4xfhYy" },
                    { name: "WSJ", iframeUrl: "https://rss.app/embed/v1/wall/t7edwlZvqrbKJvdw" },
                    { name: "AFRICA", iframeUrl: "https://rss.app/embed/v1/wall/Qq8qJlcX8Q6LVo8P" }

                ]
            },
            "X/Twitter": {
                icon: " ùïè ",
                subCategories: [
                    { 
                        name: "ALL", 
                        iframeUrl: "https://rss.app/embed/v1/wall/_b24vzGl2V15r9j6w" 
                    }, 
                    { 
                        name: "AgWeb", 
                        iframeUrl: "https://rss.app/embed/v1/wall/ssmbNtGgUfIYrizN" 
                    }, 
                    { 
                        name: "Barchart", 
                        iframeUrl: "https://rss.app/embed/v1/wall/gl8pTz7K6vuMxyYv" 
                    }, 
                    { 
                        name: "Barry Ritholtz", 
                        iframeUrl: "https://rss.app/embed/v1/wall/DySnE6hWt5PE1kHA" 
                    }, 
                    { 
                        name: "Donald J. Trump", 
                        iframeUrl: "https://rss.app/embed/v1/wall/9rbzgYGnv0PiDxK9" 
                    }, 
                    { 
                        name: "GrainStats", 
                        iframeUrl: "https://rss.app/embed/v1/wall/Tv4rfoSuQhCLljFH" 
                    }, 
                    { 
                        name: "GraInformant", 
                        iframeUrl: "https://rss.app/embed/v1/wall/3K4c1L9B9EG9Kc9h" 
                    }, 
                    { 
                        name: "Karen Braun", 
                        iframeUrl: "https://rss.app/embed/v1/wall/ClCjzvDyCZIV3zyS" 
                    }, 
                    { 
                        name: "USDA", 
                        iframeUrl: "https://rss.app/embed/v1/wall/1MCVhfiOtIyGgTkG" 
                    }, 
                    { 
                        name: "US Wheat Associates", 
                        iframeUrl: "https://rss.app/embed/v1/wall/MBXRtyhOU5q4fxNb" 
                    },                     
                    { 
                        name: "Zerohedge", 
                        iframeUrl: "https://rss.app/embed/v1/wall/FjoxmMpEtCaKNIDn" 
                    },                     
                    { 
                        name: "r/MapPorn", 
                        iframeUrl: "https://rss.app/embed/v1/wall/Vfc9wmUmOSCmWQLU" 
                    },                     
                ]
            },
            "Japan News": {
                icon: "üóæ",
                subCategories: [
                    // --- JAPAN NEWS FEEDS ---
                    { 
                        name: "„Åô„Åπ„Å¶", 
                        // This array will be populated dynamically by collectAllRssUrls() function later.
                        iframeUrl: "https://rss.app/embed/v1/wall/_TvSOOzQH9u6PzYEh"
                    },
                    { 
                        name: "„Éñ„É´„Éº„É†„Éê„Éº„Ç∞", 
                        url: [],
                        // Existing iframe URL for Bloomberg Japan
                        iframeUrl: "https://rss.app/embed/v1/wall/_l5vS2TXfngu8TgmW" 
                    },
                    { 
                        name: "„É≠„Ç§„Çø„Éº", 
                        url: [], 
                        // Existing iframe URL for Reuters Japan
                        iframeUrl: "https://rss.app/embed/v1/wall/457c8wSuEETAWGzX"
                    },
                    { 
                        name: "Êó•Êú¨ÁµåÊ∏àÊñ∞ËÅû", 
                        url: [], 
                        // Existing iframe URL for Nikkei
                        iframeUrl: "https://rss.app/embed/v1/wall/_uCusPHbKRezynJGw"
                    },
                    { 
                        name: "„Åø„Çì„Åã„Å∂", 
                        url: [], 
                        // Existing iframe URL for Minkabu
                        iframeUrl: "https://rss.app/embed/v1/wall/_T6e1jc3ar5sXwdo2"
                    },
                    { 
                        name: "Êµ∑‰∫ã„Éó„É¨„Çπ", 
                        url: [], 
                        // Existing iframe URL for Kaiji Press
                        iframeUrl: "https://rss.app/embed/v1/wall/_Q5uEUoY5NeEbIROs"
                    },
                    { 
                        name: "Êó•Êú¨Êµ∑‰∫ãÊñ∞ËÅû", 
                        // Existing iframe URL for Kaiji Shimbun
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/_35IRLWRpued4l5k4"
                    },
                    { 
                        name: "È£üÂìÅÊñ∞ËÅû", 
                        url: [],
                        // Existing iframe URL preserved
                        iframeUrl: "https://rss.app/embed/v1/wall/_qxLKReD00uQYh1FS"
                    },
                    { 
                        name: "Êó•Êú¨È£üÁ≥ßÊñ∞ËÅû", 
                        url: [], 
                        // UPDATED: New iframe URL for Japan Food Journal
                        iframeUrl: "https://rss.app/embed/v1/wall/_2UAortsZWv6lmJyb"
                    },
                    { 
                        name: "ÈâÑÈãºÊñ∞ËÅû", 
                        url: [], 
                        // „É¶„Éº„Ç∂„ÉºÊåáÂÆö„ÅÆiframe URL
                        iframeUrl: "https://rss.app/embed/v1/wall/g9tRJwsHjQGcD6jg"
                    },
                    { 
                        name: "ÂõõÂ≠£Â†±", 
                        url: [], 
                        // „É¶„Éº„Ç∂„ÉºÊåáÂÆö„ÅÆiframe URL
                        iframeUrl: "https://rss.app/embed/v1/wall/0NlCT8VqiaQqKo3D"
                    },
                    { 
                        name: "Êù±Ê¥ãÁµåÊ∏à", 
                        // ‰øÆÊ≠£: RSS URL„ÇíÂâäÈô§„Åó„ÄÅiframe URL„ÇíËøΩÂä†
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/5vXq1PQTYAcQtJbn"
                    },
                    { 
                        name: "Êó•Êú¨„ÅÆ‰∫∫‰∫ãÈÉ®", // RSS„Ç¶„Ç©„Éº„É´„Å®„Åó„Å¶Ê©üËÉΩ
                        url: [], 
                        iframeUrl: "https://rss.app/embed/v1/wall/zt4dBfaNYPvUAQYq" 
                    },
                ]
            },
        };
        
        // Function to collect all unique RSS URLs from the Japan News category, 
        // excluding the "ÂÖ®„Å¶ (All Feeds)" subcategory itself and entries with only iframeUrl.
        function collectAllRssUrls() {
            const japanNews = RSS_FEEDS["Japan News"].subCategories;
            const allRssUrls = [];
            
            japanNews.forEach(sub => {
                // Skip the "ÂÖ®„Å¶" entry itself or the one with iframeUrl
                if (sub.name.includes("ÂÖ®„Å¶") || sub.iframeUrl) return; 

                // Only collect RSS URLs if iframeUrl is NOT present and url is present
                if (sub.url && sub.url.length > 0) {
                    allRssUrls.push(...sub.url);
                }
            });
            
            // Deduplicate URLs before returning
            return [...new Set(allRssUrls)];
        }


        // --- Global State & DOM References ---
        let feedContent; 
        let currentArticles = []; 
        let isIframeView = false;
        
        // --- Persistence (localStorage) Functions ---
        function saveSelection(category, subCategory) {
            try {
                localStorage.setItem(LAST_CATEGORY_KEY, category);
                localStorage.setItem(LAST_SUB_CATEGORY_KEY, subCategory);
            } catch (e) {
                console.warn("localStorage is not available or write failed:", e);
            }
        }

        function loadSelection() {
            try {
                const lastCategory = localStorage.getItem(LAST_CATEGORY_KEY);
                const lastSubCategory = localStorage.getItem(LAST_SUB_CATEGORY_KEY);
                return { category: lastCategory, subCategory: lastSubCategory };
            } catch (e) {
                console.warn("localStorage is not available or read failed:", e);
                return { category: null, subCategory: null };
            }
        }

        // --- Modal Control Functions ---
        function showModal(title, content) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden'); 
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
        }

        // --- RSS Fetching & Parsing Functions ---

        /** Parses articles from the RSS2JSON JSON response. */
        function parseArticles(jsonResponse, url) {
            if (!jsonResponse || jsonResponse.status !== 'ok' || !jsonResponse.items) {
                console.warn(`JSON response did not contain expected data for ${url}.`, jsonResponse);
                if (jsonResponse.message) {
                    // Êó•Êú¨Ë™û„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
                    showModal("„Éï„Ç£„Éº„ÉâË™≠„ÅøËæº„Åø„Ç®„É©„Éº", `RSS„Éï„Ç£„Éº„Éâ„ÇíÂá¶ÁêÜ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éó„É≠„Ç≠„Ç∑„Åã„Çâ„Ç®„É©„Éº„Äå${jsonResponse.message}„Äç„ÅåËøî„Åï„Çå„Åæ„Åó„Åü„ÄÇURL„ÅÆÊúâÂäπÊÄß„ÇíÁ¢∫Ë™ç„Åô„Çã„Åã„ÄÅÂæå„ÅßÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                }
                return [];
            }
            
            const feedTitle = jsonResponse.feed.title || url;

            return jsonResponse.items.map(entry => {
                let fullDescription = entry.description || entry.content || '';
                
                let snippet = '';
                if (fullDescription) {
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = fullDescription;
                    // Extract text content and limit length for snippet
                    snippet = (tempElement.textContent || tempElement.innerText || '').substring(0, 250) + '...';
                }

                const imageUrl = entry.enclosure?.link || entry.thumbnail || entry.image || null;

                return {
                    title: entry.title,
                    link: entry.link,
                    snippet: snippet,
                    date: entry.pubDate,
                    imageUrl: imageUrl, 
                    feedTitle: feedTitle,
                    fullDescription: fullDescription,
                };
            });
        }

        /** Core helper to fetch a single RSS feed with exponential backoff retry logic. */
        async function fetchRSSFeedSingle(url, attempt = 0) { 
            const MAX_RETRIES = 3;
            const delay = 1000 * Math.pow(2, attempt);

            if (!url) return [];

            try {
                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    console.error(`[Attempt ${attempt + 1}/${MAX_RETRIES}] Failed to load feed ${url}. Retrying in ${delay / 1000}s.`);
                    if (attempt < MAX_RETRIES - 1) {
                         await new Promise(r => setTimeout(r, delay));
                        return fetchRSSFeedSingle(url, attempt + 1);
                    } else {
                        console.error(`[CRITICAL FEED FAILURE] Feed ${url} failed all attempts.`);
                        return [];
                    }
                }

                const json = await response.json();
                
                if (json.status && json.status !== 'ok') {
                    return parseArticles(json, url); 
                }
                
                return parseArticles(json, url);

            } catch (error) {
                if (attempt < MAX_RETRIES - 1) {
                    console.error(`[NETWORK ERROR] Feed ${url} failed. Retrying in ${delay / 1000}s. Error: ${error.message}`);
                    await new Promise(r => setTimeout(r, delay));
                    return fetchRSSFeedSingle(url, attempt + 1);
                } else {
                    console.error(`[CRITICAL NETWORK FAILURE] Feed ${url} failed all attempts. Error: ${error.message}`);
                }
                
                return []; 
            }
        }
        
        function processAndStoreArticles(articles, feedDisplayName) {
            if (!feedContent) return; 

            if (articles.length === 0) {
                currentArticles = [];
                // Check if an error modal is already displayed (which would block this from running again)
                if (!document.getElementById('modal').classList.contains('flex')) { 
                    feedContent.innerHTML = renderEmptyState(feedDisplayName, "„Åì„ÅÆË®ò‰∫ã„Åã„ÇâË®ò‰∫ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇΩ„Éº„Çπ„Åå‰∏ÄÊôÇÁöÑ„Å´Âà©Áî®„Åß„Åç„Å™„ÅÑ„Åã„ÄÅÁÑ°Âäπ„Åß„ÅÇ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ", "2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2");
                } else {
                    feedContent.innerHTML = ''; 
                }
                return;
            }
            
            // Deduplicate based on normalized title and sort by date
            const seenNormalizedTitles = new Set();
            const uniqueAndSortedArticles = articles
                .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                .filter(article => {
                    // Check for null/undefined title before processing
                    if (!article.title) return false; 
                    const normalized = article.title.toLowerCase().replace(/[^\w\s]/g, '').trim();
                    if (seenNormalizedTitles.has(normalized)) return false; 
                    seenNormalizedTitles.add(normalized);
                    return true; 
                });

            currentArticles = uniqueAndSortedArticles;
            
            const searchTerm = document.getElementById('articleSearch').value.trim();
            filterArticles(searchTerm);
        }

        function filterArticles(searchTerm) {
            if (isIframeView) return; // Do not filter if showing iframe

            const lowerSearchTerm = searchTerm.toLowerCase();

            const filtered = currentArticles.filter(article => {
                const title = article.title ? article.title.toLowerCase() : '';
                const snippet = article.snippet ? article.snippet.toLowerCase() : '';
                const fullDescription = article.fullDescription ? article.fullDescription.toLowerCase() : '';

                return title.includes(lowerSearchTerm) || 
                       snippet.includes(lowerSearchTerm) ||
                       fullDescription.includes(lowerSearchTerm);
            });

            if (filtered.length === 0) {
                feedContent.innerHTML = renderEmptyState(searchTerm, `ÁèæÂú®„ÅÆ„Éï„Ç£„Éº„Éâ„Åß„Äå<strong>${searchTerm}</strong>„Äç„Å´‰∏ÄËá¥„Åô„ÇãË®ò‰∫ã„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`, "2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2");
            } else {
                // Clear grid-span class if we are showing cards
                feedContent.classList.remove('grid-cols-1');
                feedContent.classList.add('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5');
                feedContent.innerHTML = filtered.map(article => renderArticle(article)).join('');
            }
        }
        
        /** General function to fetch and process a list of URLs */
        async function fetchFeedsAndProcess(urls, displayName) {
            if (!feedContent) return;
            
            document.getElementById('articleSearch').value = ''; 
            
            if (!urls || urls.length === 0) {
                feedContent.innerHTML = renderEmptyState(displayName, "„Éï„Ç£„Éº„ÉâURL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂà•„ÅÆ„Çµ„Éñ„Éï„Ç£„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2");
                currentArticles = [];
                return;
            }

            // Show loader
            feedContent.innerHTML = `<div class="2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2 text-center p-12 text-gray-500 italic" id="feed-loader">
                <svg class="animate-spin h-8 w-8 text-primary mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading feed: <strong>${displayName}</strong>...
            </div>`;
            
            // Fetch all URLs concurrently
            const fetchPromises = urls.map(url => fetchRSSFeedSingle(url)); 
            const results = await Promise.all(fetchPromises);
            
            const allArticles = results.flat(); 
            
            const loader = document.getElementById('feed-loader');
            if (loader) loader.remove();

            processAndStoreArticles(allArticles, displayName);
        }

        // --- Rendering Helpers ---

        function renderArticle(article) {
            const fallbackImage = 'https://placehold.co/400x180/e5e7eb/6b7280?text=No+Image';
            const imageUrl = article.imageUrl; 
            const hasImage = !!imageUrl; 

            const dateStr = article.date ? new Date(article.date).toLocaleDateString() : 'N/A';
            
            const safeArticleJson = encodeURIComponent(JSON.stringify(article));
            const handleClick = `showArticleDetails('${safeArticleJson}')`; 

            const imageBlock = hasImage ? `
                <img src="${imageUrl}" 
                     onerror="this.onerror=null;this.src='${fallbackImage}';"
                     alt="${article.title}" class="article-image">
            ` : '';
            
            return `
                <div class="feed-card bg-white rounded-xl shadow-md overflow-hidden flex flex-col border border-gray-100" onclick="${handleClick}">
                    ${imageBlock}
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2">${article.title}</h3>
                        <p class="text-sm text-gray-500 mb-3 flex-grow line-clamp-3">${article.snippet}</p>
                        <div class="flex justify-between items-center text-xs text-gray-400 border-t pt-2 mt-auto">
                            <span>${dateStr}</span>
                            <span class="font-medium text-primary">${article.feedTitle}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderIframe(iframeUrl, subCategoryName) {
            // Adjust the grid to 1 column for the wide iframe view
            feedContent.classList.add('grid-cols-1');
            feedContent.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5');

            return `
                <div class="col-span-full w-full">
                    <div class="iframe-container overflow-hidden">
                        <iframe 
                            src="${iframeUrl}" 
                            frameborder="0" 
                            title="${subCategoryName} Feed Wall">
                        </iframe>
                    </div>
                </div>
            `;
        }

        function renderEmptyState(displayName, message, spanClass = 'col-span-full') {
            // Adjust the grid to 1 column for the empty state
            feedContent.classList.add('grid-cols-1');
            feedContent.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5');
            return `<div class="${spanClass} text-center p-12 text-gray-500 italic">
                <p class="mb-2 text-gray-700 font-bold">${displayName}</p>
                ${message}
            </div>`;
        }
        
        function showArticleDetails(encodedData) {
            try {
                const articleJson = decodeURIComponent(encodedData);
                const article = JSON.parse(articleJson);

                let displayContent = article.fullDescription || article.snippet;
                
                if (!displayContent || displayContent.trim().length < 5) {
                    displayContent = `
                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-lg mb-4">
                            <p class="font-bold mb-1">„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„Éï„Ç£„Éº„Éâ„ÅßÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì</p>
                            <p>„Åì„ÅÆ„Éï„Ç£„Éº„Éâ„Ç¢„Ç§„ÉÜ„É†„Å´„ÅØ„ÄÅË®ò‰∫ãÂÖ®Êñá„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂà©Áî®ÂèØËÉΩ„Å™„Çπ„Éã„Éö„ÉÉ„Éà„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                        </div>
                        <div class="modal-body">${article.snippet}</div>
                    `;
                } else {
                    displayContent = `<div class="modal-body">${displayContent}</div>`;
                }
                
                const content = `
                    <p class="text-sm font-medium text-gray-500 mb-4">${new Date(article.date).toLocaleString() || 'Êó•‰ªò N/A'} | ${article.feedTitle}</p>
                    <div id="articleContentWrapper" class="text-gray-700 leading-relaxed overflow-y-auto max-h-[70vh] mb-6">
                        ${displayContent}
                    </div>
                    <a href="${article.link}" target="_blank" rel="noopener noreferrer" 
                       class="inline-block bg-primary text-white px-5 py-2 rounded-lg hover:bg-emerald-700 transition duration-150 font-medium shadow-md">
                        ÂÖ®Êñá„ÇíË™≠„ÇÄ &rarr;
                    </a>
                `;
                showModal(article.title, content);
            } catch (e) {
                console.error("Ë®ò‰∫ã„ÅÆË©≥Á¥∞„ÅÆ„Éá„Ç≥„Éº„Éâ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:", e);
                showModal("Ë®ò‰∫ãË™≠„ÅøËæº„Åø„Ç®„É©„Éº", "Ë®ò‰∫ã„ÅÆË©≥Á¥∞„ÇíË™≠„ÅøËæº„ÇÄ„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
            }
        }

        // --- Navigation Logic ---

        function renderCategoryNav() {
            const categoryNav = document.getElementById('categoryNav');
            // Explicitly set non-active classes in HTML structure
            // NOTE: The buttons themselves still retain a subtle border/shadow for better separation
            const baseClasses = "nav-link px-4 py-2 rounded-full text-sm transition duration-150 flex items-center md:flex-shrink-0 bg-white text-gray-600 border border-gray-200 shadow-sm font-normal";

            categoryNav.innerHTML = Object.keys(RSS_FEEDS).map(categoryName => {
                return `
                    <button onclick="selectCategory('${categoryName}')" class="${baseClasses}" data-category="${categoryName}">
                        <span class="text-lg mr-2">${RSS_FEEDS[categoryName].icon}</span>
                        <span>${categoryName}</span>
                    </button>
                `;
            }).join('');
        }

        function renderSubCategoryNav(categoryName) {
            const subCategoryNav = document.getElementById('subCategoryNav');
            const subCategories = RSS_FEEDS[categoryName].subCategories;
            // Explicitly set non-active classes in HTML structure
            const baseClasses = "sub-nav-link px-4 py-2 rounded-full text-sm transition duration-150 flex items-center bg-white text-gray-600 border border-gray-200 shadow-sm font-normal";
            
            subCategoryNav.innerHTML = subCategories.map(sub => {
                return `
                    <button onclick="selectSubCategory('${categoryName}', '${sub.name}')" 
                            class="${baseClasses}" 
                            data-sub-category="${sub.name}">
                        ${sub.name}
                    </button>
                `;
            }).join('');
        }

        function setActiveNav(categoryName, subCategoryName = null) {
            document.getElementById('activeCategoryTitle').textContent = categoryName;
            
            const subTitle = subCategoryName ? ` / ${subCategoryName}` : '';
            document.getElementById('activeSubCategoryTitle').textContent = subTitle;

            // Define ACTIVE classes explicitly for maximum priority
            const activeClasses = 'active !bg-primary !text-white !border-primary !shadow-lg !shadow-primary/50 !font-semibold';
            // Define BASE classes explicitly (same as used in render functions)
            const baseClasses = "bg-white text-gray-600 border border-gray-200 shadow-sm font-normal";

            // Highlight Main Category
            document.querySelectorAll('#categoryNav .nav-link').forEach(link => {
                if (link.getAttribute('data-category') === categoryName) {
                    // Add active classes
                    link.classList.add(...activeClasses.split(' ').filter(c => c));
                    // Ensure the icon color matches the text color for the active state
                    const icon = link.querySelector('span:first-child');
                    if (icon) icon.classList.add('text-white');
                } else {
                    // Remove active classes and restore base classes
                    link.classList.remove(...activeClasses.split(' ').filter(c => c));
                    const icon = link.querySelector('span:first-child');
                    if (icon) icon.classList.remove('text-white');
                }
            });

            // Highlight Subcategory
            document.querySelectorAll('#subCategoryNav .sub-nav-link').forEach(link => {
                if (link.getAttribute('data-sub-category') === subCategoryName) {
                     // Add active classes
                    link.classList.add(...activeClasses.split(' ').filter(c => c));
                } else {
                    // Remove active classes
                    link.classList.remove(...activeClasses.split(' ').filter(c => c));
                }
            });
        }

        function toggleSearch(show) {
            document.getElementById('searchContainer').classList.toggle('hidden', !show);
        }

        function selectCategory(categoryName) {
            
            // Check if the current category is "Japan News" and needs dynamic URL collection
            if (categoryName === "Japan News") {
                const allRssUrls = collectAllRssUrls();
                // Set the URLs for the "ÂÖ®„Å¶ (All Feeds)" subcategory dynamically
                const allFeedsSub = RSS_FEEDS["Japan News"].subCategories.find(sub => sub.name.includes("ÂÖ®„Å¶"));
                if (allFeedsSub) {
                    allFeedsSub.url = allRssUrls;
                }
            }
            
            renderSubCategoryNav(categoryName);
            
            const subCategories = RSS_FEEDS[categoryName].subCategories;

            // Get saved subcategory name for this category, or default to the first one
            const savedSelection = loadSelection();
            let subCategoryToSelect = subCategories[0]?.name;

            if (savedSelection.category === categoryName && savedSelection.subCategory) {
                // Check if the saved subCategory actually exists in the current category
                const isSubCategoryValid = subCategories.some(sub => sub.name === savedSelection.subCategory);
                if (isSubCategoryValid) {
                    subCategoryToSelect = savedSelection.subCategory;
                }
            }


            if (subCategories && subCategories.length > 0) {
                // Automatically select the first subcategory or the saved one
                selectSubCategory(categoryName, subCategoryToSelect);
            } else {
                setActiveNav(categoryName, null);
                toggleSearch(false);
                feedContent.innerHTML = renderEmptyState(categoryName, '„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´„ÅØÂÆöÁæ©„Åï„Çå„Åü„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
        }

        function selectSubCategory(categoryName, subCategoryName) {
            setActiveNav(categoryName, subCategoryName);
            // Save the selection immediately after successful display
            saveSelection(categoryName, subCategoryName);

            const category = RSS_FEEDS[categoryName];
            const subCategory = category.subCategories.find(sub => sub.name === subCategoryName);

            if (!subCategory) {
                 feedContent.innerHTML = renderEmptyState(subCategoryName, '„Çµ„Éñ„Éï„Ç£„Éº„Éâ„ÅÆÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                 toggleSearch(false);
                 return;
            }

            // --- 1. IFRAME LOGIC (Priority) ---
            if (subCategory.iframeUrl) {
                isIframeView = true;
                feedContent.innerHTML = renderIframe(subCategory.iframeUrl, subCategoryName);
                currentArticles = []; 
                toggleSearch(false); // Hide search for iframe view
                return;
            }

            // --- 2. TRADITIONAL RSS FETCHING LOGIC ---
            isIframeView = false;
            const urls = subCategory.url || [];
            if (urls.length > 0) {
                toggleSearch(true); // Show search for RSS article view
                fetchFeedsAndProcess(urls, subCategoryName);
            } else {
                // Handle empty/unconfigured feed gracefully
                toggleSearch(false);
                feedContent.innerHTML = renderEmptyState(subCategoryName, "„Åì„ÅÆ„Çµ„Éñ„Éï„Ç£„Éº„Éâ„Å´„ÅØ„ÄÅË°®Á§∫„Åô„Çã RSS URL „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                currentArticles = [];
            }
        }

        // --- Initialization ---

       window.onload = () => {
            feedContent = document.getElementById('feedContent'); 
            
            // Initialize Modal listener
            const closeModalBtn = document.getElementById('closeModal');
            const modal = document.getElementById('modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }

            // Search listener
            const searchInput = document.getElementById('articleSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(window.searchTimeout); 
                    window.searchTimeout = setTimeout(() => {
                        filterArticles(e.target.value.trim());
                    }, 300);
                });
            }
            
            renderCategoryNav(); 
            
            // --- Persistence Logic: Load saved selection or default ---
            const saved = loadSelection();
            const allCategoryNames = Object.keys(RSS_FEEDS);
            
            let categoryToLoad = allCategoryNames[0]; // Default to the first category
            
            if (saved.category && allCategoryNames.includes(saved.category)) {
                categoryToLoad = saved.category;
            }

            selectCategory(categoryToLoad);
        };

    </script>
</body>
</html>
