<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Feed Reader (RSS & Iframe)</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald 600
                        'secondary': '#10b981', // Emerald 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }; 
    </script>
    <style>
        /* Custom styles for a clean, modern look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f7; /* Changed from #f0fdfa to match iframe background */
        }
        .feed-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .feed-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .article-image {
            width: 100%;
            height: 180px; 
            object-fit: cover; 
            border-radius: 0.5rem;
            margin-bottom: 0; 
        }
        
        /* Unified style for active links (pill button look) */
        .nav-link.active, .sub-nav-link.active {
            @apply bg-primary text-white shadow-lg;
        }
        .nav-link, .sub-nav-link {
            transition: background-color 0.15s;
        }

        /* Specific style for modal content */
        .modal-body img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        /* Responsive iframe container for aspect ratio (177.78% provided by user) */
        .iframe-container {
            position: relative; 
            width: 100%; 
            padding-top: 177.78%; /* Aspect ratio: 1600/900 * 100 */
        }
        .iframe-container iframe {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            border: 0;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Modal Overlay (For RSS Article Details) --><div id="modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start border-b pb-3 mb-4">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 pr-12"></h2>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition duration-150">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="modalContent" class="text-gray-700">
                    <!-- Article content injected here --></div>
            </div>
        </div>
    </div>

    <!-- Main Content Area --><div class="max-w-screen-2xl mx-auto">
        <main class="p-4 md:p-8">
            
            <!-- 1. Main Category Navigation (Top Bar) --><h1 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Feed Categories</h1>
            <nav id="categoryNavContainer" class="bg-white p-2 rounded-xl shadow-lg mb-4 border-b-4 border-primary/20">
                <div id="categoryNav" class="flex flex-wrap gap-2 overflow-x-auto">
                    <!-- Categories injected here --></div>
            </nav>

            <!-- 2. Sub-Category Navigation (Underneath) --><h2 class="text-xl font-semibold text-gray-700 mb-2 mt-6">Sub-Feeds</h2>
            <nav id="subCategoryNav" class="bg-white p-2 rounded-xl shadow-lg mb-8 flex flex-wrap gap-2 overflow-x-auto border-l-4 border-secondary/50">
                <!-- Sub-categories injected here --></nav>
            
            <header class="mb-6">
                <h3 class="text-3xl font-extrabold text-gray-900 mb-4">
                    <span id="activeCategoryTitle" class="text-primary"></span> 
                    <span id="activeSubCategoryTitle" class="text-gray-500 font-semibold text-xl"></span>
                </h3>
            </header>
            
            <!-- 3. Search Box - Only visible/relevant for traditional RSS feeds --><div id="searchContainer" class="mb-8 hidden">
                <input type="text" id="articleSearch" placeholder="Search articles by title, snippet, or content..."
                       class="w-full p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-primary focus:border-primary transition duration-150">
            </div>

            <!-- Feed Content Grid (For RSS Articles or Iframe) --><section id="feedContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                <div class="2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2 text-center p-12 text-gray-500 italic">Please select a sub-feed to view content.</div>
            </section>
        </main>
    </div>

    <script type="text/javascript">
        // --- Configuration & Constants ---
        const CORS_PROXY = 'https://api.rss2json.com/v1/api.json?rss_url=';
        
        // RSS_FEEDS: Subcategories now use either a 'url' array (for traditional RSS) or 'iframeUrl'.
        const RSS_FEEDS = {
            "Commodity Feeds": {
                icon: "üìà",
                subCategories: [
                    { 
                        name: "X / Karen Braun", 
                        url: [], // Empty array for traditional RSS
                        iframeUrl: "https://rss.app/embed/v1/wall/ClCjzvDyCZIV3zyS" // Iframe URL takes priority
                    }, 
                    { name: "Ocean Freight Index", url: [] }, 
                    { name: "Agri-Business Insights", url: [] },
                ]
            },
            "Japan News": {
                icon: "üóæ",
                subCategories: [
                    // These use traditional RSS fetching
                    { name: "Japan Today", url: ["https://japantoday.com/feed"] },
                    { name: "Êó•Êú¨Êµ∑‰∫ãÊñ∞ËÅû", url: ["https://rss.app/feeds/OQMT4btFwBvMouT3.xml"] },
                    { name: "NHK World", url: ["https://rss.app/feeds/x00iFq34U1sKjY1I.xml"] }
                ]
            },
            "Empty Category": {
                icon: "üìÅ",
                subCategories: [
                    { name: "Empty Example", url: [] }
                ]
            },
        };

        // --- Global State & DOM References ---
        let feedContent; 
        let currentArticles = []; 
        let isIframeView = false;
        
        // --- Modal Control Functions ---
        function showModal(title, content) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden'); 
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
        }

        // --- RSS Fetching & Parsing Functions ---

        /** Parses articles from the RSS2JSON JSON response. */
        function parseArticles(jsonResponse, url) {
            if (!jsonResponse || jsonResponse.status !== 'ok' || !jsonResponse.items) {
                console.warn(`JSON response did not contain expected data for ${url}.`, jsonResponse);
                if (jsonResponse.message) {
                    showModal("Feed Loading Error", `The RSS feed could not be processed. The proxy returned the error: "${jsonResponse.message}". Please check the URL for validity or try again later.`);
                }
                return [];
            }
            
            const feedTitle = jsonResponse.feed.title || url;

            return jsonResponse.items.map(entry => {
                let fullDescription = entry.description || entry.content || '';
                
                let snippet = '';
                if (fullDescription) {
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = fullDescription;
                    // Extract text content and limit length for snippet
                    snippet = (tempElement.textContent || tempElement.innerText || '').substring(0, 250) + '...';
                }

                const imageUrl = entry.enclosure?.link || entry.thumbnail || entry.image || null;

                return {
                    title: entry.title,
                    link: entry.link,
                    snippet: snippet,
                    date: entry.pubDate,
                    imageUrl: imageUrl, 
                    feedTitle: feedTitle,
                    fullDescription: fullDescription,
                };
            });
        }

        /** Core helper to fetch a single RSS feed with exponential backoff retry logic. */
        async function fetchRSSFeedSingle(url, attempt = 0) { 
            const MAX_RETRIES = 3;
            const delay = 1000 * Math.pow(2, attempt);

            if (!url) return [];

            try {
                const proxyUrl = `${CORS_PROXY}${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    console.error(`[Attempt ${attempt + 1}/${MAX_RETRIES}] Failed to load feed ${url}. Retrying in ${delay / 1000}s.`);
                    if (attempt < MAX_RETRIES - 1) {
                         await new Promise(r => setTimeout(r, delay));
                        return fetchRSSFeedSingle(url, attempt + 1);
                    } else {
                        console.error(`[CRITICAL FEED FAILURE] Feed ${url} failed all attempts.`);
                        return [];
                    }
                }

                const json = await response.json();
                
                if (json.status && json.status !== 'ok') {
                    return parseArticles(json, url); 
                }
                
                return parseArticles(json, url);

            } catch (error) {
                if (attempt < MAX_RETRIES - 1) {
                    await new Promise(r => setTimeout(r, delay));
                    return fetchRSSFeedSingle(url, attempt + 1);
                } else {
                    console.error(`[CRITICAL NETWORK FAILURE] Feed ${url} failed all attempts. Error: ${error.message}`);
                }
                
                return []; 
            }
        }
        
        function processAndStoreArticles(articles, feedDisplayName) {
            if (!feedContent) return; 

            if (articles.length === 0) {
                currentArticles = [];
                if (!document.getElementById('modal').classList.contains('flex')) {
                    feedContent.innerHTML = renderEmptyState(feedDisplayName, "„Åì„ÅÆ„Éï„Ç£„Éº„Éâ„Åã„ÇâË®ò‰∫ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇΩ„Éº„Çπ„Åå‰∏ÄÊôÇÁöÑ„Å´Âà©Áî®„Åß„Åç„Å™„ÅÑ„Åã„ÄÅÁÑ°Âäπ„Åß„ÅÇ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ", "2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2");
                } else {
                    feedContent.innerHTML = ''; 
                }
                return;
            }
            
            // Deduplicate based on normalized title and sort by date
            const seenNormalizedTitles = new Set();
            const uniqueAndSortedArticles = articles
                .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                .filter(article => {
                    const normalized = article.title.toLowerCase().replace(/[^\w\s]/g, '').trim();
                    if (seenNormalizedTitles.has(normalized)) return false; 
                    seenNormalizedTitles.add(normalized);
                    return true; 
                });

            currentArticles = uniqueAndSortedArticles;
            
            const searchTerm = document.getElementById('articleSearch').value.trim();
            filterArticles(searchTerm);
        }

        function filterArticles(searchTerm) {
            if (isIframeView) return; // Do not filter if showing iframe

            const lowerSearchTerm = searchTerm.toLowerCase();

            const filtered = currentArticles.filter(article => {
                const title = article.title.toLowerCase();
                const snippet = article.snippet.toLowerCase();
                const fullDescription = article.fullDescription ? article.fullDescription.toLowerCase() : '';

                return title.includes(lowerSearchTerm) || 
                       snippet.includes(lowerSearchTerm) ||
                       fullDescription.includes(lowerSearchTerm);
            });

            if (filtered.length === 0) {
                feedContent.innerHTML = renderEmptyState(searchTerm, `ÁèæÂú®„ÅÆ„Éï„Ç£„Éº„Éâ„Åß„Äå<strong>${searchTerm}</strong>„Äç„Å´‰∏ÄËá¥„Åô„ÇãË®ò‰∫ã„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`, "2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2");
            } else {
                // Clear grid-span class if we are showing cards
                feedContent.classList.remove('grid-cols-1');
                feedContent.classList.add('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5');
                feedContent.innerHTML = filtered.map(article => renderArticle(article)).join('');
            }
        }
        
        /** General function to fetch and process a list of URLs */
        async function fetchFeedsAndProcess(urls, displayName) {
            if (!feedContent) return;
            
            document.getElementById('articleSearch').value = ''; 
            
            if (!urls || urls.length === 0) {
                feedContent.innerHTML = renderEmptyState(displayName, "„Éï„Ç£„Éº„ÉâURL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂà•„ÅÆ„Çµ„Éñ„Éï„Ç£„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", "2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2");
                currentArticles = [];
                return;
            }

            // Show loader
            feedContent.innerHTML = `<div class="2xl:col-span-5 xl:col-span-4 lg:col-span-3 md:col-span-2 text-center p-12 text-gray-500 italic" id="feed-loader">
                <svg class="animate-spin h-8 w-8 text-primary mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading feed: <strong>${displayName}</strong>...
            </div>`;
            
            // Fetch all URLs concurrently
            const fetchPromises = urls.map(url => fetchRSSFeedSingle(url)); 
            const results = await Promise.all(fetchPromises);
            
            const allArticles = results.flat(); 
            
            const loader = document.getElementById('feed-loader');
            if (loader) loader.remove();

            processAndStoreArticles(allArticles, displayName);
        }

        // --- Rendering Helpers ---

        function renderArticle(article) {
            const fallbackImage = 'https://placehold.co/400x180/e5e7eb/6b7280?text=No+Image';
            const imageUrl = article.imageUrl; 
            const hasImage = !!imageUrl; 

            const dateStr = article.date ? new Date(article.date).toLocaleDateString() : 'N/A';
            
            const safeArticleJson = encodeURIComponent(JSON.stringify(article));
            const handleClick = `showArticleDetails('${safeArticleJson}')`; 

            const imageBlock = hasImage ? `
                <img src="${imageUrl}" 
                     onerror="this.onerror=null;this.src='${fallbackImage}';"
                     alt="${article.title}" class="article-image">
            ` : '';
            
            return `
                <div class="feed-card bg-white rounded-xl shadow-md overflow-hidden flex flex-col border border-gray-100" onclick="${handleClick}">
                    ${imageBlock}
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2">${article.title}</h3>
                        <p class="text-sm text-gray-500 mb-3 flex-grow line-clamp-3">${article.snippet}</p>
                        <div class="flex justify-between items-center text-xs text-gray-400 border-t pt-2 mt-auto">
                            <span>${dateStr}</span>
                            <span class="font-medium text-primary">${article.feedTitle}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderIframe(iframeUrl, subCategoryName) {
            // Adjust the grid to 1 column for the wide iframe view
            feedContent.classList.add('grid-cols-1');
            feedContent.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5');

            return `
                <div class="col-span-full w-full">
                    <div class="iframe-container rounded-xl shadow-2xl overflow-hidden">
                        <iframe 
                            src="${iframeUrl}" 
                            frameborder="0" 
                            title="${subCategoryName} Feed Wall">
                        </iframe>
                    </div>
                </div>
            `;
        }

        function renderEmptyState(displayName, message, spanClass = 'col-span-full') {
            // Adjust the grid to 1 column for the empty state
            feedContent.classList.add('grid-cols-1');
            feedContent.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', '2xl:grid-cols-5');
            return `<div class="${spanClass} text-center p-12 text-gray-500 italic">
                <p class="mb-2 text-gray-700 font-bold">${displayName}</p>
                ${message}
            </div>`;
        }
        
        // --- Navigation Logic ---

        function renderCategoryNav() {
            const categoryNav = document.getElementById('categoryNav');
            categoryNav.innerHTML = Object.keys(RSS_FEEDS).map(categoryName => {
                return `
                    <button onclick="selectCategory('${categoryName}')" class="nav-link text-gray-600 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200 transition duration-150 flex items-center" data-category="${categoryName}">
                        <span class="text-lg mr-2">${RSS_FEEDS[categoryName].icon}</span>
                        <span>${categoryName}</span>
                    </button>
                `;
            }).join('');
        }

        function renderSubCategoryNav(categoryName) {
            const subCategoryNav = document.getElementById('subCategoryNav');
            const subCategories = RSS_FEEDS[categoryName].subCategories;
            
            subCategoryNav.innerHTML = subCategories.map(sub => {
                return `
                    <button onclick="selectSubCategory('${categoryName}', '${sub.name}')" 
                            class="sub-nav-link text-gray-600 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-200 transition duration-150 flex items-center" 
                            data-sub-category="${sub.name}">
                        ${sub.name}
                    </button>
                `;
            }).join('');
        }

        function setActiveNav(categoryName, subCategoryName = null) {
            document.getElementById('activeCategoryTitle').textContent = categoryName;
            
            const subTitle = subCategoryName ? ` / ${subCategoryName}` : '';
            document.getElementById('activeSubCategoryTitle').textContent = subTitle;

            document.querySelectorAll('#categoryNav .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-category') === categoryName) {
                    link.classList.add('active');
                }
            });

            document.querySelectorAll('#subCategoryNav .sub-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            if (subCategoryName) {
                const activeSubCategoryLink = document.querySelector(`#subCategoryNav .sub-nav-link[data-sub-category="${subCategoryName}"]`);
                if (activeSubCategoryLink) {
                    activeSubCategoryLink.classList.add('active');
                }
            }
        }

        function toggleSearch(show) {
            document.getElementById('searchContainer').classList.toggle('hidden', !show);
        }

        function selectCategory(categoryName) {
            renderSubCategoryNav(categoryName);
            
            const subCategories = RSS_FEEDS[categoryName].subCategories;

            if (subCategories && subCategories.length > 0) {
                // Automatically select the first subcategory
                selectSubCategory(categoryName, subCategories[0].name);
            } else {
                setActiveNav(categoryName, null);
                toggleSearch(false);
                feedContent.innerHTML = renderEmptyState(categoryName, '„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´„ÅØÂÆöÁæ©„Åï„Çå„Åü„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
        }

        function selectSubCategory(categoryName, subCategoryName) {
            setActiveNav(categoryName, subCategoryName);

            const category = RSS_FEEDS[categoryName];
            const subCategory = category.subCategories.find(sub => sub.name === subCategoryName);

            if (!subCategory) {
                 feedContent.innerHTML = renderEmptyState(subCategoryName, '„Çµ„Éñ„Éï„Ç£„Éº„Éâ„ÅÆÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                 toggleSearch(false);
                 return;
            }

            // --- 1. IFRAME LOGIC (Priority) ---
            if (subCategory.iframeUrl) {
                isIframeView = true;
                feedContent.innerHTML = renderIframe(subCategory.iframeUrl, subCategoryName);
                currentArticles = []; 
                toggleSearch(false); // Hide search for iframe view
                return;
            }

            // --- 2. TRADITIONAL RSS FETCHING LOGIC ---
            isIframeView = false;
            const urls = subCategory.url || [];
            if (urls.length > 0) {
                toggleSearch(true); // Show search for RSS article view
                fetchFeedsAndProcess(urls, subCategoryName);
            } else {
                // Handle empty/unconfigured feed gracefully
                toggleSearch(false);
                feedContent.innerHTML = renderEmptyState(subCategoryName, "„Åì„ÅÆ„Çµ„Éñ„Éï„Ç£„Éº„Éâ„Å´„ÅØ„ÄÅË°®Á§∫„Åô„Çã RSS URL „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                currentArticles = [];
            }
        }

        // --- Initialization ---

       window.onload = () => {
            feedContent = document.getElementById('feedContent'); 
            
            // Initialize Modal listener
            const closeModalBtn = document.getElementById('closeModal');
            const modal = document.getElementById('modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }

            // Search listener
            const searchInput = document.getElementById('articleSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(window.searchTimeout); 
                    window.searchTimeout = setTimeout(() => {
                        filterArticles(e.target.value.trim());
                    }, 300);
                });
            }
            
            renderCategoryNav(); 
            
            // Default load the 'Commodity Feeds' category
            selectCategory('Commodity Feeds');
        };

    </script>
</body>
</html>
