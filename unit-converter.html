<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grain Unit Converter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 0.5rem; 
        }
        .converter-card {
            max-width: 1200px; 
            width: 100%;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.05), 0 3px 10px -3px rgba(0, 0, 0, 0.03);
        }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='currentColor'%3e%3cpath d='M7 7l3-3 3 3m0 6l-3 3-3-3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2em;
        }
        /* Primary Blue Button Theme */
        #calculate-btn {
            background-color: #3b82f6;
            color: white;
            font-size: 1.125rem; 
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
            transition: background-color 0.2s, transform 0.1s;
        }
        #calculate-btn:hover {
            background-color: #2563eb;
        }
        #calculate-btn:active {
            transform: scale(0.99);
        }

        /* Result box styles */
        .result-row {
            padding: 0.75rem 0; 
            margin: 0 0.5rem;
            border-bottom: 1px dashed #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem; 
        }
        .result-row:last-child {
            border-bottom: none;
        }
        .result-row span:last-child {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.125rem; 
        }
        
        /* Input Grid and Spacing */
        .input-grid {
            display: grid;
            gap: 1.5rem; 
            grid-template-columns: 1fr;
        }
        @media (min-width: 768px) { 
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* Standard input padding */
        .input-field {
            padding: 0.5rem; 
        }
        /* Label font size */
        .input-label {
            font-size: 0.875rem; 
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="text-center mb-4 mt-2">
        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Grain Unit Converter</h1>
        <p class="text-sm text-gray-500 mt-0.5">Quantity, Price, and Value Calculator</p>
    </header>

    <div class="converter-card p-4 md:p-6">
        
        <form id="conversion-form" class="space-y-3">

            <!-- MAIN INPUT AND CURRENCY INPUT IN A FLEXIBLE TWO-COLUMN GRID -->
            <div class="input-grid">

                <!-- COLUMN 1: Grain, Quantity, Price, and Price Unit -->
                <div class="space-y-3">
                    <h3 class="text-base font-semibold text-gray-700">Quantity and Price Inputs</h3>
                    
                    <!-- 1. Grain Type Select -->
                    <div>
                        <label for="grain-type" class="block input-label font-medium text-gray-700 mb-1">Grain</label>
                        <select id="grain-type" class="custom-select w-full input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm">
                            <option value="corn">Corn (56 lbs/bu)</option>
                            <option value="wheat">Wheat (60 lbs/bu)</option>
                            <option value="soybeans">Soybeans (60 lbs/bu)</option>
                            <!-- ACCURATE CONVERSION: Soybean Meal is 47.53 lbs/bu (based on 2000 lbs / 42.08 bu) -->
                            <option value="soybean_meal">Soybean Meal (47.53 lbs/bu)</option>
                            <option value="canola">Canola/Rapeseed (50 lbs/bu)</option>
                            <option value="barley">Barley (48 lbs/bu)</option>
                            <option value="sorghum">Sorghum/Milo (56 lbs/bu)</option>
                        </select>
                    </div>

                    <!-- 2. Quantity Input and Unit Select (Input Unit) -->
                    <div>
                        <label for="quantity" class="block input-label font-medium text-gray-700 mb-1">Quantity</label>
                        <div class="flex space-x-2">
                            <input type="number" id="quantity" value="60000" min="0" step="any" required
                                class="w-2/3 input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm" placeholder="Enter quantity">
                            <select id="input-unit" class="custom-select w-1/3 input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm">
                                <option value="lbs">Pounds (lbs)</option>
                                <option value="bu">Bushels</option>
                                <option value="metric_ton" selected>Metric Tons</option>
                                <option value="short_ton">Short Tons</option>
                                <option value="cwt">CWT (100 lbs)</option>
                                <option value="bag_60kg">Bags (60 kg)</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3. Price Input (Optional) + 4. Price Unit Select -->
                    <div>
                        <label for="price" class="block input-label font-medium text-gray-700 mb-1">Price (Base Currency) and Unit</label>
                        <div class="flex space-x-2">
                            <!-- Price Input -->
                            <div class="flex items-center w-2/3 space-x-1">
                                <span id="base-currency-symbol" class="text-lg text-gray-500 font-semibold">$</span>
                                <input type="number" id="price" value="4.50" min="0" step="any"
                                    class="w-full input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm" placeholder="Price value">
                            </div>
                            <!-- Price Unit Select -->
                            <select id="price-unit" class="custom-select w-1/3 input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm">
                                <option value="bu" selected>/ Bushel</option>
                                <option value="lbs">/ Pound (lbs)</option>
                                <option value="cwt">/ CWT (100 lbs)</option>
                                <option value="metric_ton">/ Metric Ton</option>
                                <option value="short_ton">/ Short Ton</option>
                                <option value="bag_60kg">/ Bag (60 kg)</option>
                            </select>
                        </div>
                    </div>

                </div>

                <!-- COLUMN 2: Currency Settings and Exchange Rate -->
                <div class="space-y-3">
                    <h3 class="text-base font-semibold text-gray-700">Currency and Factor Inputs</h3>

                    <!-- 1. Base Currency -->
                    <div>
                        <label for="base-currency" class="block input-label font-medium text-gray-700 mb-1">Base Currency</label>
                        <select id="base-currency" class="custom-select w-full input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm">
                            <option value="USD" selected>USD - United States Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="BRL">BRL - Brazilian Real</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                        </select>
                    </div>

                    <!-- 2. Target Currency -->
                    <div>
                        <label for="target-currency" class="block input-label font-medium text-gray-700 mb-1">Target Currency</label>
                        <select id="target-currency" class="custom-select w-full input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm">
                            <option value="EUR">EUR - Euro</option>
                            <option value="BRL">BRL - Brazilian Real</option>
                            <option value="USD">USD - United States Dollar</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="CAD">CAD - Canadian Dollar</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="JPY" selected>JPY - Japanese Yen</option>
                        </select>
                    </div>

                    <!-- 3. Exchange Rate Input - Only the input box is bordered, labels are outside -->
                    <div>
                        <label for="exchange-rate" class="block input-label font-medium text-gray-700 mb-1">Exchange Rate (Use Manual Input if API Fails)</label>
                        
                        <!-- Flex container to hold the label, input, and symbol on the same line -->
                        <div class="flex space-x-2 items-center">
                            
                            <!-- Leading Label (e.g., 1 USD =) -->
                            <span id="rate-label" class="text-base text-gray-600 font-medium whitespace-nowrap">1 USD =</span>
                            
                            <!-- The single, bordered input box for the numerical rate -->
                            <input type="number" id="exchange-rate" value="0.92" min="0.001" step="any"
                                class="w-full input-field border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-900 shadow-sm" 
                                placeholder="Rate">
                            
                            <!-- Trailing Symbol (e.g., ¥) -->
                            <span id="rate-target-symbol" class="text-lg text-gray-500 font-semibold whitespace-nowrap">¥</span>
                        </div>
                         <!-- Live Rate Status -->
                        <p id="rate-status" class="text-xs text-gray-500 mt-1 text-right"></p>
                    </div>
                </div>
            </div>

            <!-- Calculation Button -->
            <div class="pt-2 flex justify-center">
                <button type="submit" id="calculate-btn" class="w-full md:w-1/3 py-2 rounded-xl font-bold shadow-md hover:shadow-lg">
                    Calculate Conversion
                </button>
            </div>
        </form>

        <!-- 5. Results Display Section -->
        <div id="results" class="mt-4 border-t border-gray-200 pt-4 p-2 rounded-lg bg-gray-50 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-2 text-center">Conversion Results</h3>

            <div class="input-grid space-y-0">
                
                <!-- COLUMN 1 (Results): Mass & Volume Conversions -->
                <div>
                    <h4 class="text-xs font-semibold text-blue-700 pt-1">Mass & Volume Conversions</h4>
                    <!-- Volume/Mass Conversions -->
                    <div class="result-row">
                        <span>Total Volume (Bushels):</span>
                        <span id="result-bu">0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Total Mass (Pounds):</span>
                        <span id="result-lbs">0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Total Mass (Bags 60 kg):</span>
                        <span id="result-bag-60kg">0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Total Mass (Metric Tons):</span>
                        <span id="result-metric-ton">0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Total Mass (Short Tons):</span>
                        <span id="result-short-ton">0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Total Mass (CWT):</span>
                        <span id="result-cwt">0.00</span>
                    </div>
                </div>

                <!-- COLUMN 2 (Results): Price & Value Estimates & Futures -->
                <div>
                    <h4 class="text-xs font-semibold text-green-700 pt-1 border-t md:border-t-0 border-gray-200">Price & Value Estimates</h4>

                    <!-- 1. Price per Selected Price Unit (Target Currency) -->
                    <div id="price-per-price-unit-target-row" class="hidden result-row">
                        <span id="price-per-price-unit-target-label"></span>
                        <span id="price-per-price-unit-target"></span>
                    </div>
                    
                    <!-- DEDICATED ROW: Price per Metric Ton (Target Currency) - SHOWN ONLY IF Price Unit != MT AND Input Unit != MT -->
                    <div id="price-per-metric-ton-target-row" class="hidden result-row">
                        <span id="price-per-metric-ton-target-label" class="font-medium text-gray-700"></span>
                        <span id="price-per-metric-ton-target-value"></span>
                    </div>

                    <!-- 2. Price per Input Unit (Base Currency) -->
                    <div id="price-per-input-unit-base-row" class="hidden result-row">
                        <span id="price-per-input-unit-base-label"></span>
                        <span id="price-per-input-unit-base"></span>
                    </div>

                    <!-- 3. Price per Input Unit (Target Currency) -->
                    <div id="price-per-input-unit-target-row" class="hidden result-row">
                        <span id="price-per-input-unit-target-label"></span>
                        <span id="price-per-input-unit-target-value"></span>
                    </div>

                    <!-- 4. Total Value Calculation -->
                    <div id="value-result-row" class="hidden result-row bg-yellow-100 rounded-md my-1 py-2 border-none">
                        <span class="font-bold text-gray-800">TOTAL ESTIMATED VALUE (<span id="target-currency-code-display">JPY</span>):</span>
                        <span id="result-value" class="font-extrabold text-base text-blue-700"></span>
                    </div>
                    
                    <h4 class="text-xs font-semibold text-red-700 pt-1 border-t border-gray-200">Futures Contracts</h4>
                    <!-- Futures Contract Result -->
                    <div id="futures-result-row" class="result-row hidden">
                        <span id="futures-label"></span>
                        <span id="result-futures">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. Message Box (replaces alert()) -->
        <div id="message-box" class="fixed top-0 left-1/2 -translate-x-1/2 mt-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-lg shadow-lg z-50 hidden" role="alert">
            <!-- Message text will be inserted here -->
        </div>

    </div>

    <script>
        // --- Grain Constants (Weight in lbs per Bushel) ---
        const CONVERSION_RATES = {
            corn: 56,       // lbs per bushel
            wheat: 60,      // lbs per bushel
            soybeans: 60,    // lbs per bushel
            soybean_meal: 2000/42.08, // lbs per bushel (Uses the required fractional calculation)
            canola: 50,
            barley: 48,
            sorghum: 56
        };

        // --- Futures Contract Constants (Units per 1 Contract) ---
        const FUTURES_CONTRACTS = {
            corn: { unit: 'bu', size: 5000, exchange: 'CME', label: 'Corn (5,000 bu) Contracts:' },
            wheat: { unit: 'bu', size: 5000, exchange: 'CME', label: 'Wheat (5,000 bu) Contracts:' },
            soybeans: { unit: 'bu', size: 5000, exchange: 'CME', label: 'Soybean (5,000 bu) Contracts:' },
            // UPDATED LABEL: from 'Soy Meal (100 sh.t) Contracts:' to full text
            soybean_meal: { unit: 'short_ton', size: 100, exchange: 'CME', label: 'Soybean Meal (100 Short Tons) Contracts:' },
            // AMENDED LABEL: from 'Canola (20 MT) Contracts:' to full text
            canola: { unit: 'metric_ton', size: 20, exchange: 'ICE', label: 'Canola (20 Metric Tons) Contracts:' },
        };

        // --- Mass Constants ---
        const KG_PER_BAG = 60;
        const LBS_PER_KG = 2.20462;
        const LBS_PER_METRIC_TON = 2204.62;
        const LBS_PER_SHORT_TON = 2000;
        const LBS_PER_CWT = 100;
        const LBS_PER_60KG_BAG = KG_PER_BAG * LBS_PER_KG; 

        // Map from select value to display text (for labels)
        const UNIT_DISPLAY = {
            'lbs': 'Pounds (lbs)',
            'bu': 'Bushel', 
            'metric_ton': 'Metric Ton',
            'short_ton': 'Short Ton',
            'bag_60kg': 'Bag (60 kg)',
            'cwt': 'CWT (100 lbs)'
        };

        // --- Currency Map for Symbols and Formatting ---
        const CURRENCY_MAP = {
            'USD': { symbol: '$', locale: 'en-US' },
            'EUR': { symbol: '€', locale: 'de-DE' },
            'BRL': { symbol: 'R$', locale: 'pt-BR' },
            'GBP': { symbol: '£', locale: 'en-GB' },
            'CAD': { symbol: '$', locale: 'en-CA' },
            'AUD': { symbol: '$', locale: 'en-AU' },
            'JPY': { symbol: '¥', locale: 'ja-JP' },
        };

        // --- Local Storage Keys ---
        const STORAGE_KEYS = {
            grain: 'gc_grain',
            quantity: 'gc_quantity',
            inputUnit: 'gc_input_unit',
            price: 'gc_price',
            priceUnit: 'gc_price_unit',
            baseCurrency: 'gc_base_currency',
            targetCurrency: 'gc_target_currency'
        };


        // --- DOM Elements ---
        const form = document.getElementById('conversion-form');
        const quantityInput = document.getElementById('quantity');
        const priceInput = document.getElementById('price');

        const grainTypeSelect = document.getElementById('grain-type');
        const inputUnitSelect = document.getElementById('input-unit');
        const priceUnitSelect = document.getElementById('price-unit');

        // Currency Elements
        const baseCurrencySelect = document.getElementById('base-currency');
        const targetCurrencySelect = document.getElementById('target-currency');
        const exchangeRateInput = document.getElementById('exchange-rate');
        const baseCurrencySymbolSpan = document.getElementById('base-currency-symbol');
        const rateLabelSpan = document.getElementById('rate-label');
        const rateTargetSymbolSpan = document.getElementById('rate-target-symbol');
        const targetCurrencyCodeDisplay = document.getElementById('target-currency-code-display');
        const rateStatus = document.getElementById('rate-status');
        
        const messageBox = document.getElementById('message-box');

        const resultsDiv = document.getElementById('results');
        const resultLbs = document.getElementById('result-lbs');
        const resultBu = document.getElementById('result-bu');
        const resultMetricTon = document.getElementById('result-metric-ton');
        const resultShortTon = document.getElementById('result-short-ton');
        const resultBag60Kg = document.getElementById('result-bag-60kg');
        const valueResultRow = document.getElementById('value-result-row');
        const resultValue = document.getElementById('result-value');
        
        // Futures Elements
        const futuresResultRow = document.getElementById('futures-result-row');
        const resultFutures = document.getElementById('result-futures');
        const futuresLabel = document.getElementById('futures-label');

        // Price Per Unit Elements
        const pricePerPriceUnitTargetRow = document.getElementById('price-per-price-unit-target-row');
        const pricePerPriceUnitTargetLabel = document.getElementById('price-per-price-unit-target-label');
        const pricePerPriceUnitTarget = document.getElementById('price-per-price-unit-target');

        // Price per Input Unit (Base and Target)
        const pricePerInputUnitBaseRow = document.getElementById('price-per-input-unit-base-row');
        const pricePerInputUnitBaseLabel = document.getElementById('price-per-input-unit-base-label');
        const pricePerInputUnitBase = document.getElementById('price-per-input-unit-base');

        const pricePerInputUnitTargetRow = document.getElementById('price-per-input-unit-target-row');
        const pricePerInputUnitTargetLabel = document.getElementById('price-per-input-unit-target-label');
        const pricePerInputUnitTargetValueElement = document.getElementById('price-per-input-unit-target-value');
        
        // Dedicated Price per Metric Ton Elements
        const pricePerMetricTonTargetRow = document.getElementById('price-per-metric-ton-target-row');
        const pricePerMetricTonTargetLabel = document.getElementById('price-per-metric-ton-target-label');
        const pricePerMetricTonTargetValueElement = document.getElementById('price-per-metric-ton-target-value');

        
        /**
         * Displays a temporary message box.
         */
        function showMessage(message) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Saves current input values to localStorage.
         */
        function saveInputValues() {
            try {
                localStorage.setItem(STORAGE_KEYS.grain, grainTypeSelect.value);
                localStorage.setItem(STORAGE_KEYS.quantity, quantityInput.value);
                localStorage.setItem(STORAGE_KEYS.inputUnit, inputUnitSelect.value);
                localStorage.setItem(STORAGE_KEYS.price, priceInput.value);
                localStorage.setItem(STORAGE_KEYS.priceUnit, priceUnitSelect.value);
                localStorage.setItem(STORAGE_KEYS.baseCurrency, baseCurrencySelect.value);
                localStorage.setItem(STORAGE_KEYS.targetCurrency, targetCurrencySelect.value);
            } catch (e) {
                console.error("Could not save to local storage:", e);
            }
        }
        
        /**
         * Restores input values from localStorage on page load.
         */
        function restoreInputValues() {
            const setStoredValue = (element, key) => {
                const storedValue = localStorage.getItem(key);
                if (storedValue) {
                    // Check if a select option exists before setting
                    if (element.tagName === 'SELECT') {
                        const optionExists = Array.from(element.options).some(option => option.value === storedValue);
                        if (optionExists) {
                            element.value = storedValue;
                        }
                    } else {
                        element.value = storedValue;
                    }
                }
            };
            
            try {
                setStoredValue(grainTypeSelect, STORAGE_KEYS.grain);
                setStoredValue(quantityInput, STORAGE_KEYS.quantity);
                setStoredValue(inputUnitSelect, STORAGE_KEYS.inputUnit);
                setStoredValue(priceInput, STORAGE_KEYS.price);
                setStoredValue(priceUnitSelect, STORAGE_KEYS.priceUnit);
                setStoredValue(baseCurrencySelect, STORAGE_KEYS.baseCurrency);
                setStoredValue(targetCurrencySelect, STORAGE_KEYS.targetCurrency);
                // NOTE: Exchange Rate is deliberately NOT restored per user request.
            } catch (e) {
                console.error("Could not restore from local storage:", e);
            }
        }
        
        /**
         * Fetches the live exchange rate from an external public API.
         */
        async function getLiveExchangeRate(baseCode, targetCode) {
            // If currencies are the same, rate is 1.0, no API call needed.
            if (baseCode === targetCode) {
                return 1.0;
            }
            
            // Start loading state
            exchangeRateInput.disabled = true;
            rateTargetSymbolSpan.classList.add('animate-pulse', 'text-yellow-600');
            rateTargetSymbolSpan.textContent = '...';
            rateStatus.textContent = 'Fetching live rate...';
            
            // Use the open exchange rate API (free, no API key needed for basic usage)
            const apiUrl = `https://open.er-api.com/v6/latest/${baseCode}`;
            
            let rate = null;

            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result === 'success' && data.rates && data.rates[targetCode]) {
                    rate = data.rates[targetCode];
                    rateStatus.textContent = 'Live rate updated.';
                    rateStatus.classList.remove('text-red-500');
                    rateStatus.classList.add('text-green-600');
                } else {
                    throw new Error('Invalid response structure or target currency missing.');
                }
            } catch (error) {
                console.error("Failed to fetch live exchange rate from external API:", error);
                rateStatus.textContent = 'Failed to fetch live rate. Using manual input.';
                rateStatus.classList.remove('text-green-600');
                rateStatus.classList.add('text-red-500');

                // Fallback: If API fails, return the current manual input rate
                return parseFloat(exchangeRateInput.value) || 1.0;
            } finally {
                // Remove loading state
                exchangeRateInput.disabled = false;
                rateTargetSymbolSpan.classList.remove('animate-pulse', 'text-yellow-600');
                rateTargetSymbolSpan.textContent = CURRENCY_MAP[targetCode]?.symbol || targetCode;
            }
            
            return rate;
        }


        // --- Conversion and Calculation Functions ---

        /**
         * Converts the input quantity to a base unit (lbs).
         */
        function toPounds(quantity, unit, grain) {
            const lbsPerBushel = CONVERSION_RATES[grain];

            switch (unit) {
                case 'lbs':
                    return quantity;
                case 'bu':
                    return quantity * lbsPerBushel;
                case 'metric_ton':
                    return quantity * LBS_PER_METRIC_TON;
                case 'short_ton':
                    return quantity * LBS_PER_SHORT_TON;
                case 'cwt':
                    return quantity * LBS_PER_CWT;
                case 'bag_60kg':
                    return quantity * LBS_PER_60KG_BAG;
                default:
                    return 0;
            }
        }

        /**
         * Calculates the total number of futures contracts based on the grain type and total mass/volume.
         */
        function calculateFuturesContracts(totalBushels, totalMetricTons, totalShortTons, grain) {
            
            // Default Barley and Sorghum to Corn contracts
            let contractGrain = grain;
            if (grain === 'barley' || grain === 'sorghum') {
                contractGrain = 'corn';
            }

            const contract = FUTURES_CONTRACTS[contractGrain];
            
            if (!contract) return null; 

            // Calculate contracts based on the required unit for the contract type
            let totalContracts;
            if (contract.unit === 'bu') {
                totalContracts = totalBushels / contract.size;
            } else if (contract.unit === 'metric_ton') {
                totalContracts = totalMetricTons / contract.size;
            } else if (contract.unit === 'short_ton') {
                totalContracts = totalShortTons / contract.size;
            } else {
                return null;
            }
            
            return { contracts: totalContracts, label: contract.label };
        }


        /**
         * Updates the currency symbols, rate label, and fetches the live exchange rate.
         */
        async function updateCurrencyDisplay() { 
            const baseCode = baseCurrencySelect.value;
            const targetCode = targetCurrencySelect.value;

            // 1. Update Base Currency Symbol next to Price Input
            baseCurrencySymbolSpan.textContent = CURRENCY_MAP[baseCode]?.symbol || baseCode;

            // 2. Update Exchange Rate Label and Target Symbol
            rateLabelSpan.textContent = `1 ${baseCode} =`;
            rateTargetSymbolSpan.textContent = CURRENCY_MAP[targetCode]?.symbol || targetCode;
            
            // 3. Update Result Title
            targetCurrencyCodeDisplay.textContent = targetCode;

            // 4. Fetch and update live exchange rate
            const liveRate = await getLiveExchangeRate(baseCode, targetCode);

            if (baseCode === targetCode) {
                 // If currencies are the same, ensure the rate is 1
                 exchangeRateInput.value = 1.0000;
            } else if (liveRate !== null && liveRate !== undefined) {
                // If a valid rate is fetched (API success or fallback to current rate), update the input field
                exchangeRateInput.value = liveRate.toFixed(4); 
            } 
            
            // 5. Trigger recalculation immediately after rate is updated
            if (parseFloat(quantityInput.value) > 0) {
                 handleConversion({ preventDefault: () => {} });
            }
        }

        /**
         * Helper function to format currency.
         */
        function formatCurrency(value, currencyCode) {
            const info = CURRENCY_MAP[currencyCode] || { locale: undefined };
            return new Intl.NumberFormat(info.locale, {
                style: 'currency',
                currency: currencyCode,
                // Ensure 2 decimals for financial readability
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(value);
        }

        /**
         * Main calculation and display function.
         */
        function handleConversion(event) {
            if (event) event.preventDefault(); // Stop form submission

            const quantity = parseFloat(quantityInput.value);
            const price = parseFloat(priceInput.value);
            const exchangeRate = parseFloat(exchangeRateInput.value);

            const grain = grainTypeSelect.value;
            const inputUnit = inputUnitSelect.value;
            const priceUnit = priceUnitSelect.value;
            const baseCurrencyCode = baseCurrencySelect.value;
            const targetCurrencyCode = targetCurrencySelect.value;

            const rate = isNaN(exchangeRate) || exchangeRate <= 0 ? 1 : exchangeRate;

            if (isNaN(quantity) || quantity <= 0) {
                resultsDiv.classList.add('hidden');
                saveInputValues(); // Still save state if quantity is invalid, but don't show results
                return;
            }

            // 1. Convert everything to the base unit (LBS)
            const totalLbs = toPounds(quantity, inputUnit, grain);
            const lbsPerBushel = CONVERSION_RATES[grain];

            // 2. Perform all required conversions (Mass/Volume)
            const totalBushels = totalLbs / lbsPerBushel;
            const totalMetricTons = totalLbs / LBS_PER_METRIC_TON;
            const totalShortTons = totalLbs / LBS_PER_SHORT_TON;
            const totalBag60Kg = totalLbs / LBS_PER_60KG_BAG;

            const totalCWT = totalLbs / LBS_PER_CWT;

            // Use Intl.NumberFormat for better localization of large numbers
            const numberFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });

            resultBu.textContent = numberFormatter.format(totalBushels);
            resultLbs.textContent = numberFormatter.format(totalLbs);
            resultShortTon.textContent = numberFormatter.format(totalShortTons);
            resultMetricTon.textContent = numberFormatter.format(totalMetricTons);
            resultBag60Kg.textContent = numberFormatter.format(totalBag60Kg);

            document.getElementById('result-cwt').textContent = numberFormatter.format(totalCWT);

            // Futures Contracts Result
            const futuresResult = calculateFuturesContracts(totalBushels, totalMetricTons, totalShortTons, grain);

            if (futuresResult) {
                futuresLabel.textContent = futuresResult.label;
                resultFutures.textContent = new Intl.NumberFormat(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 3 }).format(futuresResult.contracts);
                futuresResultRow.classList.remove('hidden');
            } else {
                futuresResultRow.classList.add('hidden');
            }

            // --- Price & Value Calculations ---
            const hasPrice = !isNaN(price) && price > 0;

            if (hasPrice) {
                
                // 3. Calculate price of 1 lb in BASE currency (rateLbs)
                let rateLbs = 0;
                switch (priceUnit) {
                    case 'bu':
                        rateLbs = price / lbsPerBushel;
                        break;
                    case 'lbs':
                        rateLbs = price;
                        break;
                    case 'cwt':
                        rateLbs = price / LBS_PER_CWT;
                        break;
                    case 'metric_ton':
                        rateLbs = price / LBS_PER_METRIC_TON;
                        break;
                    case 'short_ton':
                        rateLbs = price / LBS_PER_SHORT_TON;
                        break;
                    case 'bag_60kg':
                        rateLbs = price / LBS_PER_60KG_BAG;
                        break;
                }

                // Total Value in Base Currency
                const totalBaseValue = totalLbs * rateLbs;

                // 1. Price per Selected Price Unit (Target Currency)
                const pricePerPriceUnitTargetValue = price * rate;
                pricePerPriceUnitTargetLabel.textContent = `Price per ${UNIT_DISPLAY[priceUnit]} (${targetCurrencyCode}):`;
                pricePerPriceUnitTarget.textContent = formatCurrency(pricePerPriceUnitTargetValue, targetCurrencyCode);
                pricePerPriceUnitTargetRow.classList.remove('hidden');

                
                // --- Price per Metric Ton (Target Currency) ---
                // Show this row ONLY IF:
                // 1. The selected price unit is NOT metric_ton.
                // 2. The selected input unit is NOT metric_ton.
                if (priceUnit !== 'metric_ton' && inputUnit !== 'metric_ton') {
                    const pricePerMT_TargetValue = rateLbs * LBS_PER_METRIC_TON * rate;
                    pricePerMetricTonTargetLabel.textContent = `Price per Metric Ton (${targetCurrencyCode}):`;
                    pricePerMetricTonTargetValueElement.textContent = formatCurrency(pricePerMT_TargetValue, targetCurrencyCode);
                    pricePerMetricTonTargetRow.classList.remove('hidden');
                } else {
                    pricePerMetricTonTargetRow.classList.add('hidden');
                }
                

                // 2. Price per Input Unit (Base Currency)
                const pricePerInputUnitBaseValue = totalBaseValue / quantity;
                pricePerInputUnitBaseLabel.textContent = `Price per ${UNIT_DISPLAY[inputUnit]} (${baseCurrencyCode}):`;
                pricePerInputUnitBase.textContent = formatCurrency(pricePerInputUnitBaseValue, baseCurrencyCode);
                pricePerInputUnitBaseRow.classList.remove('hidden');

                // 4. Price per Input Unit (Target Currency)
                const pricePerInputUnitTargetValue = pricePerInputUnitBaseValue * rate;
                pricePerInputUnitTargetLabel.textContent = `Price per ${UNIT_DISPLAY[inputUnit]} (${targetCurrencyCode}):`;
                pricePerInputUnitTargetValueElement.textContent = formatCurrency(pricePerInputUnitTargetValue, targetCurrencyCode);
                pricePerInputUnitTargetRow.classList.remove('hidden');


                // 5. Total Estimated Value (Target Currency)
                const finalValue = totalBaseValue * rate;
                resultValue.textContent = formatCurrency(finalValue, targetCurrencyCode);
                valueResultRow.classList.remove('hidden');
            } else {
                // Hide all price/value rows if no price is entered
                valueResultRow.classList.add('hidden');
                pricePerPriceUnitTargetRow.classList.add('hidden');
                pricePerMetricTonTargetRow.classList.add('hidden');
                pricePerInputUnitBaseRow.classList.add('hidden');
                pricePerInputUnitTargetRow.classList.add('hidden');
            }

            // Show results area
            resultsDiv.classList.remove('hidden');

            // Save current state for next load
            saveInputValues();
        }

        // --- Event Listeners ---
        form.addEventListener('submit', handleConversion);

        // Listen for changes on currency selects to trigger symbol/label update and API call
        baseCurrencySelect.addEventListener('change', updateCurrencyDisplay);
        targetCurrencySelect.addEventListener('change', updateCurrencyDisplay);

        // Listen for changes on all other inputs to trigger conversion
        exchangeRateInput.addEventListener('input', handleConversion);
        priceInput.addEventListener('input', handleConversion);
        quantityInput.addEventListener('input', handleConversion);
        grainTypeSelect.addEventListener('change', handleConversion);
        inputUnitSelect.addEventListener('change', handleConversion);
        priceUnitSelect.addEventListener('change', handleConversion);


        // Initial setup and calculation on load
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Restore previous values (except exchange rate)
            restoreInputValues();

            // 2. Initiate the first API call to populate the initial rate, and trigger calculation
            await updateCurrencyDisplay();
        });

    </script>
</body>
</html>
